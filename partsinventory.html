<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Parts Inventory & Orders</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <link rel="stylesheet" href="app.css">
  <style>
    /* Page styles (fallback/background) */
    :root {
      --bg-dark: #0f1318;
      --bg-panel: #151821;
      --accent: #4fd1c5;
      --accent-2: #7ef0df;
      --text-main: #e6eef2;
      --text-muted: #9fb2bf;
      --border: #22272f;
    }
    body {
      padding: 0;
      color: var(--text-main);
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      background: var(--bg-dark);
      min-height: 100vh;
    }
    .page-content { padding: 1.5rem; }
    .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); }
    .sidebar { max-height: calc(100vh - 4rem); overflow-y: auto; }
    .toast-container { position: fixed; right: 1rem; bottom: 1rem; z-index: 1200; }
    .chart-wrap { min-height: 240px; }
    .log-entry { font-size: .95rem; color: var(--text-main); }
    .muted { color: rgba(230,238,248,0.7); }
    .low-stock { color: #ffb4a2; font-weight: 600; }
    .usage-item { font-weight: 600; color: var(--text-main); }
    .list-group-item { color: var(--text-main); }
    .card-title { color: var(--text-main); font-weight: 600; }
    .form-label { color: var(--text-main); font-weight: 500; }

    /* Make form controls match dark theme (remove bright white background)
       Keep this limited to small form controls used on the page so other
       Bootstrap forms are unaffected. */
    #itemInput,
    #qtyInput,
    .form-control.form-control-sm {
      background: transparent;
      /* make input text slightly brighter for readability */
      color: #ffffff;
      border: 1px solid var(--border);
      box-shadow: none;
    }

    /* brighter placeholder so it's readable but still visually muted */
    #itemInput::placeholder,
    #qtyInput::placeholder,
    .form-control.form-control-sm::placeholder {
      color: rgba(255,255,255,0.70);
      opacity: 1; /* ensure consistent rendering across browsers */
    }

    /* subtle focus ring for accessibility */
    #itemInput:focus,
    #qtyInput:focus,
    .form-control.form-control-sm:focus {
      outline: 2px solid rgba(127, 224, 211, 0.12);
      outline-offset: 0;
      border-color: var(--accent);
      background: rgba(255,255,255,0.01);
    }
  </style>
</head>
<body>
  <!-- Shared site header -->
  <header class="site-header">
    <div class="header-inner" role="banner" aria-label="Obsidian Bastion header">
      <div class="header-left">
        <div class="site-emblem" aria-hidden="true" title="Obsidian Bastion emblem">
          <img src="https://obviouslymelissa-hub.github.io/obsidianbastion/images/StrOpBoard.png" alt="Strategic Operations Board">
        </div>
        <div class="header-text" aria-label="Site title">
          <h1>Obsidian Bastion</h1>
          <h2>Parts Inventory & Orders</h2>
        </div>
      </div>
      <div class="header-right">
        <a href="https://obviouslymelissa-hub.github.io/obsidianbastion/onboardcomputer.html" class="return-command-hub" aria-label="Return to Onboard Computer">← Return</a>
      </div>
    </div>
  </header>

  <div class="page-content">
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 mb-0">Inventory & Parts Ordering Dashboard</h1>
    </div>

    <div class="row g-3">
      <!-- Left: Charts -->
      <div class="col-lg-8">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="card-title">Ship Systems Inventory</h5>
              <div class="chart-wrap">
                <canvas id="partsChart"></canvas>
              </div>
              <p class="mt-2 mb-0 muted">Critical ship parts</p>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card p-3">
              <h5 class="card-title">Crew Supplies</h5>
              <div class="chart-wrap">
                <canvas id="suppliesChart"></canvas>
              </div>
              <p class="mt-2 mb-0 muted">Food, Water and Medical Kits</p>
            </div>
          </div>

          <!-- Restock Suggestions moved to left column, below the charts -->
          <div class="col-12">
            <div class="card p-3">
              <h6 class="card-title">Restock Recommendations</h6>
              <ul id="restockList" class="list-group list-group-flush mt-2">
                <!-- dynamic suggestions -->
              </ul>
            </div>
          </div>

          <!-- Outgoing supplies & maintenance usage log (shows 5 most recent) moved to left column -->
          <div class="col-12">
            <div class="card p-3">
              <h6 class="card-title">Outgoing Usage Log</h6>
              <ul id="usageLog" class="list-group list-group-flush mt-2">
                <!-- dynamic usage entries (most recent 5) -->
              </ul>
            </div>
          </div>

        </div>
      </div>

      <!-- Right: Order form + Logs -->
      <div class="col-lg-4">
        <div class="card p-3 mb-3">
          <h5 class="card-title">Order Parts / Supplies</h5>
          <form id="orderForm" class="row g-2">
            <div class="col-12">
              <label for="itemInput" class="form-label small">Item</label>
              <input list="suggestions" id="itemInput" class="form-control form-control-sm" placeholder="e.g. engine, thruster, power cell" required>
              <datalist id="suggestions">
                <option value="engine">
                <option value="thruster">
                <option value="power cell">
                <option value="coolant pump">
                <option value="sensor module">
                <option value="antenna">
                <option value="hull plate">
                <option value="navigation computer">
                <option value="solar panel">
                <option value="battery">
                <option value="oxygen filter">
                <option value="medical kit">
                <option value="food rations">
                <option value="water pack">
              </datalist>
            </div>

            <div class="col-6">
              <label for="qtyInput" class="form-label small">Quantity</label>
              <input type="number" id="qtyInput" class="form-control form-control-sm" value="1" min="1" required>
            </div>

            <div class="col-6 d-flex align-items-end">
              <button type="submit" class="btn btn-primary btn-sm w-100">Order</button>
            </div>
          </form>

          <hr class="my-3">

          <div>
            <p class="mb-1 small muted">Quick Controls</p>
            <div class="d-flex gap-2">
              <button id="clearLogBtn" class="btn btn-outline-danger btn-sm">Clear Log</button>
            </div>
          </div>
        </div>

        <div class="card p-3 sidebar">
          <h6 class="card-title">Order Log</h6>
          <ul id="orderLog" class="list-group list-group-flush mt-2">
            <!-- dynamic entries -->
          </ul>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal: Order confirmation -->
  <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-0">
          <h5 class="modal-title">Order Placed</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="orderModalText" class="mb-0"></p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Custom part delivery decision -->
  <div class="modal fade" id="customPartModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-0">
          <h5 class="modal-title">Custom Part Delivered</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="customPartModalText" class="mb-3"></p>
          <p class="small text-muted">Would you like to use this part immediately or store it for later?</p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-primary btn-sm" id="useNowBtn">Use Now</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="storeBtn">Store for Later</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toasts container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Bootstrap 5 JS (bundle includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- Data & Persistence ---
    const defaultInventory = {
      engine: 2,
      thruster: 6,
      'power cell': 20,
      'sensor module': 8,
      'hull plate': 10,
      'coolant pump': 4,
      antenna: 2,
      'food rations': 200,
      'water pack': 150,
      'oxygen filter': 8,
      'medical kit': 2
    };

    // For random initialization and consumption tuning per item
    const ITEM_RANGES = {
      engine:         { min: 1,  max: 3,   perTickProb: 0.01, maxDecrease: 1 },
      thruster:       { min: 2,  max: 12,  perTickProb: 0.02, maxDecrease: 1 },
      'power cell':   { min: 12, max: 40,  perTickProb: 0.05, maxDecrease: 2 },
      'sensor module':{ min: 4,  max: 12,  perTickProb: 0.02, maxDecrease: 1 },
      'hull plate':   { min: 6,  max: 18,  perTickProb: 0.005, maxDecrease: 1 },
      'coolant pump': { min: 2,  max: 6,   perTickProb: 0.01, maxDecrease: 1 },
      antenna:        { min: 1,  max: 4,   perTickProb: 0.005, maxDecrease: 1 },
      'food rations': { min: 150,max: 400, perTickProb: 0.3, maxDecrease: 2 },
      'water pack':   { min: 120,max: 300, perTickProb: 0.25,  maxDecrease: 2 },
      'oxygen filter':{ min: 4,  max: 12,  perTickProb: 0.02, maxDecrease: 1 },
      'medical kit':  { min: 1,  max: 6,   perTickProb: 0.04, maxDecrease: 1 }
    };

    const RESTOCK_THRESHOLDS = {
      engine: 1,
      thruster: 2,
      'power cell': 8,
      'sensor module': 3,
      'hull plate': 4,
      'coolant pump': 2,
      antenna: 1,
      'food rations': 80,
      'water pack': 60,
      'oxygen filter': 3,
      'medical kit': 1
    };

    const STORAGE_KEYS = {
      INVENTORY: 'ship.inventory.v1',
      ORDERS: 'ship.orders.v1',
      USAGE: 'ship.usage.v1',
      CUSTOM_PARTS: 'ship.customparts.v1'
    };

    const SESSION_RANDOM_KEY = 'ship.inventory.randomized.v1';

    function loadInventory() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.INVENTORY);
        const parsed = raw ? JSON.parse(raw) : {};
        // Merge parsed (saved) values into defaults so new keys are present even if old saves exist
        return { ...defaultInventory, ...parsed };
      } catch (e) {
        return { ...defaultInventory };
      }
    }
    function saveInventory(inv) {
      localStorage.setItem(STORAGE_KEYS.INVENTORY, JSON.stringify(inv));
    }

    function loadOrders() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.ORDERS);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        return [];
      }
    }
    function saveOrders(orders) {
      localStorage.setItem(STORAGE_KEYS.ORDERS, JSON.stringify(orders));
    }

    function loadUsage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.USAGE);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        return [];
      }
    }
    function saveUsage(log) {
      localStorage.setItem(STORAGE_KEYS.USAGE, JSON.stringify(log));
    }

    function loadCustomParts() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.CUSTOM_PARTS);
        return raw ? JSON.parse(raw) : {};
      } catch (e) {
        return {};
      }
    }
    function saveCustomParts(parts) {
      localStorage.setItem(STORAGE_KEYS.CUSTOM_PARTS, JSON.stringify(parts));
    }

    // --- Application state ---
    let inventory = loadInventory();
    let orders = loadOrders();
    let usage = loadUsage(); // outgoing supplies & maintenance usage log
    let customParts = loadCustomParts(); // tracks custom parts stored for later use

    // If the session hasn't been randomized yet, initialize with random values within ITEM_RANGES
    function randomBetween(min, max) {
      return min + Math.floor(Math.random() * (max - min + 1));
    }
    function generateRandomInventory() {
      const inv = { ...inventory }; // start from merged defaults (so unknown keys kept)
      for (const k of Object.keys(ITEM_RANGES)) {
        const r = ITEM_RANGES[k];
        inv[k] = randomBetween(r.min, r.max);
      }
      return inv;
    }
    function randomizeInventoryIfNeeded() {
      try {
        if (!sessionStorage.getItem(SESSION_RANDOM_KEY)) {
          inventory = generateRandomInventory();
          saveInventory(inventory);
          sessionStorage.setItem(SESSION_RANDOM_KEY, '1');
        } else {
          // ensure keys from ITEM_RANGES exist even if saved inventory misses them
          for (const k of Object.keys(ITEM_RANGES)) {
            if (inventory[k] == null) inventory[k] = ITEM_RANGES[k].min;
          }
          saveInventory(inventory);
        }
      } catch (e) {
        // ignore
      }
    }
    randomizeInventoryIfNeeded();

    // --- Charts setup (deferred until DOM is ready to avoid preview timing issues) ---
    // Chart instances (created on DOMContentLoaded)
    let partsChart = null;
    let suppliesChart = null;

    const PARTS_ORDER = ['engine', 'thruster', 'power cell', 'sensor module', 'hull plate', 'coolant pump', 'antenna'];
    const SUPPLIES_ORDER = ['food rations', 'water pack', 'medical kit'];

    function capitalizeLabel(s) {
      return s.split(' ').map(p => p[0].toUpperCase() + p.slice(1)).join(' ');
    }

    function refreshCharts() {
      if (partsChart) {
        // Include custom parts in the chart (only those not already in PARTS_ORDER)
        const customPartKeys = Object.keys(customParts).filter(k => {
          return !isStandardPart(k) && (inventory[k] || 0) > 0;
        });
        const allPartsKeys = [...PARTS_ORDER, ...customPartKeys];
        const allPartsLabels = allPartsKeys.map(k => {
          // For custom parts, use the displayName; for standard parts, just capitalize the key
          if (customParts[k]) {
            return capitalizeLabel(customParts[k].displayName);
          }
          return capitalizeLabel(k);
        });
        const allPartsData = allPartsKeys.map(k => inventory[k] || 0);
        
        // Generate colors: use standard colors for standard parts, generate for custom
        const standardColors = ['#6b4f4f','#937746','#4e6b6f','#3e6f59','#355d78','#556b61','#7a5e46'];
        const customColors = customPartKeys.map((_, i) => {
          const hue = (i * 60) % 360;
          return `hsl(${hue}, 35%, 45%)`;
        });
        
        partsChart.data.labels = allPartsLabels;
        partsChart.data.datasets[0].data = allPartsData;
        partsChart.data.datasets[0].backgroundColor = [
          ...standardColors.slice(0, PARTS_ORDER.length),
          ...customColors
        ];
        partsChart.update();
      }
      if (suppliesChart) {
        suppliesChart.data.datasets[0].data = SUPPLIES_ORDER.map(k => inventory[k] || 0);
        suppliesChart.update();
      }
    }

    // --- UI: Log rendering ---
    const orderLogEl = document.getElementById('orderLog');
    const restockListEl = document.getElementById('restockList');
    const usageLogEl = document.getElementById('usageLog');

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString();
    }

    function renderLog() {
      orderLogEl.innerHTML = '';
      if (!orders.length) {
        orderLogEl.innerHTML = '<li class="list-group-item bg-transparent muted">No orders yet.</li>';
        return;
      }
      orders.slice().reverse().forEach(o => {
        const li = document.createElement('li');
        li.className = 'list-group-item bg-transparent d-flex justify-content-between align-items-start log-entry';
        li.innerHTML = `
          <div>
            <div class="fw-semibold">${escapeHtml(o.item)} <small class="text-muted">×${o.qty}</small></div>
            <div class="muted small">${formatTime(o.orderedAt)}</div>
          </div>
          <div class="text-end">
            <span class="badge ${o.status === 'Delivered' ? 'bg-success' : 'bg-warning'}">${o.status}</span>
            <div class="muted small mt-1">${o.status === 'Delivered' ? formatTime(o.deliveredAt) : ''}</div>
          </div>
        `;
        orderLogEl.appendChild(li);
      });
    }

    // --- Usage log rendering (outgoing supplies & maintenance) ---
    function renderUsageLog() {
      usageLogEl.innerHTML = '';
      if (!usage.length) {
        usageLogEl.innerHTML = '<li class="list-group-item bg-transparent muted">No outgoing usage recorded.</li>';
        return;
      }
      // show only the most recent 5 entries on screen
      const recent = usage.slice().reverse().slice(0, 5);
      recent.forEach(u => {
        const li = document.createElement('li');
        li.className = 'list-group-item bg-transparent d-flex justify-content-between align-items-start log-entry';
        li.innerHTML = `
          <div>
            <div class="usage-item">${capitalizeLabel(u.item)} <small class="text-muted">−${u.qty}</small></div>
            <div class="muted small">${formatTime(u.ts)}</div>
          </div>
          <div class="text-end">
            <small class="muted">${escapeHtml(u.source || '')}</small>
          </div>
        `;
        usageLogEl.appendChild(li);
      });
    }

    // --- Restock suggestions ---
    function renderRestockSuggestions() {
      restockListEl.innerHTML = '';
      const keys = Object.keys(RESTOCK_THRESHOLDS);
      const low = keys.filter(k => (inventory[k] || 0) <= RESTOCK_THRESHOLDS[k]);
      if (!low.length) {
        restockListEl.innerHTML = '<li class="list-group-item bg-transparent muted">All systems sufficiently stocked.</li>';
        return;
      }

      low.forEach(k => {
        const li = document.createElement('li');
        li.className = 'list-group-item bg-transparent d-flex justify-content-between align-items-center';
        const qtyNeed = Math.max(1, Math.ceil((RESTOCK_THRESHOLDS[k] * 2) - (inventory[k] || 0)));
        li.innerHTML = `
          <div>
            <div class="${inventory[k] <= Math.max(1, Math.floor(RESTOCK_THRESHOLDS[k] / 2)) ? 'low-stock' : ''}">${capitalizeLabel(k)}</div>
            <div class="muted small">Current: ${inventory[k] || 0} • Recommend: ${qtyNeed}</div>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary me-1 restock-btn" data-item="${escapeHtml(k)}" data-qty="${qtyNeed}">Order ${qtyNeed}</button>
          </div>
        `;
        restockListEl.appendChild(li);
      });

      // attach listeners
      restockListEl.querySelectorAll('.restock-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const item = btn.getAttribute('data-item');
          const qty = parseInt(btn.getAttribute('data-qty'), 10) || 1;
          placeOrder(item, qty);
        });
      });
    }

    // --- Utilities ---
    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }

    // --- Toast notifications (Bootstrap) ---
    const toastContainer = document.getElementById('toastContainer');

    function showToast(title, body, options = {}) {
      const id = 't' + Date.now();
      const el = document.createElement('div');
      el.className = 'toast align-items-center text-bg-dark border';
      el.role = 'alert';
      el.ariaLive = 'polite';
      el.ariaAtomic = 'true';
      el.id = id;

      el.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <strong>${escapeHtml(title)}</strong> — <span class="muted">${escapeHtml(body)}</span>
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;

      toastContainer.appendChild(el);
      const toast = new bootstrap.Toast(el, { delay: options.delay || 4000 });
      toast.show();
      el.addEventListener('hidden.bs.toast', () => el.remove());
    }

    // --- Ordering flow ---
    const orderForm = document.getElementById('orderForm');
    const itemInput = document.getElementById('itemInput');
    const qtyInput = document.getElementById('qtyInput');
    const orderModal = new bootstrap.Modal(document.getElementById('orderModal'));
    const orderModalText = document.getElementById('orderModalText');

    function placeOrder(itemRaw, qtyRaw) {
      const item = String(itemRaw).trim().toLowerCase();
      const qty = Math.max(1, parseInt(qtyRaw, 10) || 1);
      const orderedAt = Date.now();

      const order = {
        id: 'o' + orderedAt + Math.floor(Math.random() * 999),
        item,
        qty,
        status: 'Ordered',
        orderedAt,
        deliveredAt: null
      };

      orders.push(order);
      saveOrders(orders);
      renderLog();
      renderRestockSuggestions();
      // Show modal + toast
      orderModalText.textContent = `Ordered ${qty} × ${item}.`;
      orderModal.show();
      showToast('Order placed', `${qty} × ${item}`, { delay: 2500 });

      // Simulate delivery delay (random 3–9 seconds)
      const delayMs = 3000 + Math.floor(Math.random() * 7000);
      setTimeout(() => deliverOrder(order.id), delayMs);
    }

    function deliverOrder(orderId) {
      const idx = orders.findIndex(o => o.id === orderId);
      if (idx === -1) return;
      const o = orders[idx];
      if (o.status === 'Delivered') return;
      o.status = 'Delivered';
      o.deliveredAt = Date.now();

      saveOrders(orders);
      renderLog();

      // Check if this is a custom part (not in standard inventory)
      if (!isStandardPart(o.item)) {
        // Show custom part modal for decision
        showCustomPartModal(o);
      } else {
        // Standard part - add directly to inventory
        const key = normalizeKey(o.item);
        if (inventory[key] == null) inventory[key] = 0;
        inventory[key] += o.qty;
        saveInventory(inventory);
        refreshCharts();
        renderRestockSuggestions();
        showToast('Delivered', `${o.qty} × ${o.item} arrived`, { delay: 4000 });
      }
    }

    // Show modal for custom part delivery decision
    const customPartModal = new bootstrap.Modal(document.getElementById('customPartModal'));
    const customPartModalText = document.getElementById('customPartModalText');
    let pendingCustomPart = null;

    function showCustomPartModal(order) {
      pendingCustomPart = order;
      customPartModalText.textContent = `${order.qty} × ${order.item} has been delivered!`;
      customPartModal.show();
    }

    // Handle "Use Now" button
    document.getElementById('useNowBtn').addEventListener('click', () => {
      if (!pendingCustomPart) return;
      
      // Add directly to inventory and mark as used
      const key = normalizeKey(pendingCustomPart.item);
      if (inventory[key] == null) inventory[key] = 0;
      inventory[key] += pendingCustomPart.qty;
      saveInventory(inventory);
      
      customPartModal.hide();
      refreshCharts();
      renderRestockSuggestions();
      showToast('Part Used', `${pendingCustomPart.qty} × ${pendingCustomPart.item} added to active inventory`, { delay: 4000 });
      pendingCustomPart = null;
    });

    // Handle "Store for Later" button
    document.getElementById('storeBtn').addEventListener('click', () => {
      if (!pendingCustomPart) return;
      
      const key = normalizeKey(pendingCustomPart.item);
      
      // Add to custom parts storage
      if (customParts[key] == null) {
        customParts[key] = {
          qty: 0,
          displayName: pendingCustomPart.item,
          // Custom parts can be consumed like standard parts, with moderate probability
          perTickProb: 0.015,
          maxDecrease: 1
        };
      }
      customParts[key].qty += pendingCustomPart.qty;
      saveCustomParts(customParts);
      
      // Also add to inventory for immediate tracking and consumption
      if (inventory[key] == null) inventory[key] = 0;
      inventory[key] += pendingCustomPart.qty;
      saveInventory(inventory);
      
      customPartModal.hide();
      refreshCharts();
      renderRestockSuggestions();
      showToast('Part Stored', `${pendingCustomPart.qty} × ${pendingCustomPart.item} stored for future use`, { delay: 4000 });
      pendingCustomPart = null;
    });

    function normalizeKey(item) {
      const k = item.toLowerCase().trim();
      if (k.includes('food') || k.includes('ration')) return 'food rations';
      if (k.includes('water')) return 'water pack';
      if (k.includes('engine')) return 'engine';
      if (k.includes('thruster')) return 'thruster';
      if (k.includes('power')) return 'power cell';
      if (k.includes('sensor')) return 'sensor module';
      if (k.includes('coolant')) return 'coolant pump';
      if (k.includes('antenna')) return 'antenna';
      if (k.includes('hull')) return 'hull plate';
      if (k.includes('oxygen')) return 'oxygen filter';
      if (k.includes('medical')) return 'medical kit';
      if (k.includes('solar')) return 'solar panel';
      if (k.includes('battery')) return 'battery';
      return k; // general fallback
    }

    // Check if item is a known standard part (in ITEM_RANGES or defaultInventory)
    function isStandardPart(item) {
      const key = normalizeKey(item);
      return key in ITEM_RANGES || key in defaultInventory;
    }

    // --- Form handling ---
    orderForm.addEventListener('submit', (ev) => {
      ev.preventDefault();
      const item = itemInput.value.trim();
      const qty = qtyInput.value;
      if (!item) {
        itemInput.classList.add('is-invalid');
        setTimeout(() => itemInput.classList.remove('is-invalid'), 1200);
        return;
      }
      placeOrder(item, qty);
      // clear the input but keep suggestions
      itemInput.value = '';
      qtyInput.value = 1;
    });

    // --- Buttons: clear log, reset inventory ---
    document.getElementById('clearLogBtn').addEventListener('click', () => {
      if (!confirm('Clear order log? This cannot be undone.')) return;
      orders = [];
      saveOrders(orders);
      renderLog();
      showToast('Order log cleared', '', { delay: 2000 });
    });



    // --- Usage simulation: periodically consume items according to ITEM_RANGES ---
    // This interval is started after DOMContentLoaded along with chart creation.
    const USAGE_TICK_MS = 5000; // every 5s (faster drain)
    const SUPPLIES_KEYS = new Set(['food rations', 'water pack', 'medical kit']);
    // maintenance keys are everything else listed in ITEM_RANGES (excluding supplies)
    const MAINTENANCE_KEYS = new Set(Object.keys(ITEM_RANGES).filter(k => !SUPPLIES_KEYS.has(k)));

    // Defer chart creation and interval start until DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      // basic sanity checks
      if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded — charts cannot be created.');
        return;
      }

      const partsCtx = document.getElementById('partsChart');
      const suppliesCtx = document.getElementById('suppliesChart');

      // create charts
      partsChart = new Chart(partsCtx, {
        type: 'doughnut',
        data: {
          labels: PARTS_ORDER.map(l => capitalizeLabel(l)),
          datasets: [{
            data: PARTS_ORDER.map(k => inventory[k] || 0),
            // darker, more muted palette (reduced brightness)
            backgroundColor: ['#6b4f4f','#937746','#4e6b6f','#3e6f59','#355d78','#556b61','#7a5e46'],
            hoverOffset: 6
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#e6eef8' } } }
        }
      });

      suppliesChart = new Chart(suppliesCtx, {
        type: 'doughnut',
        data: {
          labels: SUPPLIES_ORDER.map(l => capitalizeLabel(l)),
          datasets: [{
            data: SUPPLIES_ORDER.map(k => inventory[k] || 0),
            // darker supplies palette
            backgroundColor: ['#3e6f59', '#355d78', '#7a5858'],
            hoverOffset: 6
          }]
        },
        options: { plugins: { legend: { labels: { color: '#e6eef8' } } } }
      });

      // initial render that depends on DOM & charts
      renderLog();
      refreshCharts();
      renderRestockSuggestions();
      renderUsageLog();

      // start usage simulation interval
      setInterval(() => {
        let changed = false;
        const now = Date.now();
        // Process standard parts from ITEM_RANGES
        for (const k of Object.keys(ITEM_RANGES)) {
          const cfg = ITEM_RANGES[k];
          if (Math.random() < cfg.perTickProb) {
            // choose a decrement from 1..maxDecrease (but not larger than available)
            const dec = 1 + Math.floor(Math.random() * cfg.maxDecrease);
            const old = inventory[k] || 0;
            const next = Math.max(0, old - dec);
            if (next !== old) {
              inventory[k] = next;
              changed = true;

              // If this is a supply or maintenance part, log outgoing usage
              if (SUPPLIES_KEYS.has(k) || MAINTENANCE_KEYS.has(k)) {
                const entry = {
                  id: 'u' + now + Math.floor(Math.random() * 999),
                  item: k,
                  qty: Math.min(dec, old),
                  ts: now,
                  // use 'crew' for supplies, 'maintenance' for parts
                  source: SUPPLIES_KEYS.has(k) ? 'crew' : 'maintenance'
                };
                usage.push(entry);
                // keep usage log to a reasonable size in storage, but show only last 5 on screen
                if (usage.length > 300) usage.splice(0, usage.length - 300);
              }
            }
          }
        }
        
        // Process custom parts
        for (const k of Object.keys(customParts)) {
          const cfg = customParts[k];
          if (Math.random() < cfg.perTickProb) {
            const dec = 1 + Math.floor(Math.random() * cfg.maxDecrease);
            const old = inventory[k] || 0;
            const next = Math.max(0, old - dec);
            if (next !== old) {
              inventory[k] = next;
              changed = true;

              // Log custom part usage
              const entry = {
                id: 'u' + now + Math.floor(Math.random() * 999),
                item: k,
                qty: Math.min(dec, old),
                ts: now,
                source: 'maintenance'
              };
              usage.push(entry);
              if (usage.length > 300) usage.splice(0, usage.length - 300);
            }
          }
        }
        
        if (changed) {
          saveInventory(inventory);
          saveUsage(usage);
          refreshCharts();
          renderRestockSuggestions();
          renderUsageLog();
        }
      }, USAGE_TICK_MS);
    });

    // Expose small helper to console for testing
    window.shipInventory = {
      inventory, orders, usage, customParts, placeOrder, deliverOrder, refreshCharts, renderRestockSuggestions, generateRandomInventory
    };
  </script>

  <footer style="text-align:center;color:rgba(230,238,248,0.6);padding:24px 0 40px;border-top:1px solid rgba(255,255,255,0.03);margin-top:18px;font-style:italic;">
    <div style="margin-bottom:12px">
      <a href="https://obviouslymelissa-hub.github.io/obsidianbastion/index.html" style="color:#6ee7b7;text-decoration:none;font-weight:600">Vessel Profile</a>
    </div>
    &copy; 2026 - Turning Imagination Into Galactic Frontiers.
  </footer>
  </div>
</body>
</html>
