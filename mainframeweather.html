<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Planetary Atmospherics</title>
  <style>
    :root{
      --bg:#0b0f1a; --card:#0f1724; --muted:#9aa6c0; --accent:#6ee7b7;
      --danger:#ff7b7b; --glass: rgba(255,255,255,0.03);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#041024 0%, #071025 60%);color:#e6eef8;}
    .wrap{max-width:980px;margin:36px auto;padding:24px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .header-left{display:flex;flex-direction:column}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    .controls .center{display:flex;gap:10px;align-items:center}
    button{background:var(--accent);color:#042023;border:0;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
    .toggle{display:flex;align-items:center;gap:8px;font-size:14px}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:16px;margin-top:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .item{padding:10px;background:var(--glass);border-radius:8px}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .big{font-size:18px;font-weight:700}
    .composition{margin-top:10px;display:flex;flex-direction:column;gap:6px}
    .comp-row{display:flex;justify-content:space-between;font-size:13px}
    .bar{height:10px;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden;margin-top:6px}
    .bar > i{display:block;height:100%;background:linear-gradient(90deg,#6ee7b7,#60a5fa);width:0%}
    .rightcol{display:flex;flex-direction:column;gap:12px}
    .visual-tabs{display:flex;gap:8px;border-bottom:1px dashed rgba(255,255,255,0.03);padding-bottom:8px;margin-bottom:8px}
    .tab{padding:6px 10px;border-radius:8px;background:transparent;color:var(--muted);cursor:pointer}
    .tab.active{background:rgba(255,255,255,0.02);color:var(--accent);font-weight:700}
    .visual-canvas{height:200px;display:flex;align-items:center;justify-content:center}
    .json{white-space:pre-wrap;background:#041427;padding:12px;border-radius:8px;color:#bfe6ff;font-size:13px;max-height:420px;overflow:auto}
    .footer{margin-top:18px;color:var(--muted);font-size:13px}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:600}
    .good{color:var(--accent);font-weight:700}
    .bad{color:var(--danger);font-weight:700}
    .small{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .unit-switch{display:flex;align-items:center;gap:6px}
    .unit-switch input{width:16px;height:16px}
    /* Habitability gauge */
    .gauge { width:140px; height:140px; display:inline-block; }
    /* Removed rotation here so the SVG text isn't rotated */
    .funfacts{font-size:13px;line-height:1.4;color:#d9f6ff}
    .save-note{font-size:12px;color:var(--muted);margin-left:8px}
    .header-actions{display:flex;gap:8px;align-items:center}
    input[type="text"].planet-name{padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    /* thumbnail gallery */
    .thumb-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .thumb{width:88px;height:88px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);background:#031a2b;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="header-left">
        <h1>Planetary Atmospherics</h1>
        <div class="small">Solar system and planet explorer with atmospheric conditions and habitability check.</div>
      </div>

      <div class="controls">
        <div class="center">
          <div class="toggle">
            <label><input id="earthToggle" type="checkbox"> Current Earth Conditions</label>
          </div>

          <!-- Unit toggle -->
          <div class="unit-switch">
            <label><input id="unitToggle" type="checkbox"> Show °C</label>
          </div>

          <div style="display:flex;align-items:center;gap:6px">
            <input id="planetNameInput" class="planet-name" type="text" placeholder="Give this planet a name (optional)">
          </div>
        </div>
      </div>

      <div class="header-actions">
        <button id="shuffle">Random Planet</button>
        <button id="findHabitable">Find Habitable</button>
        <button id="generateThumb">Generate Thumbnail</button>
        <button id="downloadThumb">Download Thumbnail</button>
        <button id="saveFavorite">Save Favorite</button>
        <div id="saveNote" class="save-note" aria-live="polite"></div>
      </div>
    </header>

    <div class="grid">
      <div>
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
              <div class="label">System</div>
              <div class="big" id="systemName">—</div>
              <div class="small" id="starInfo">Star: —</div>
            </div>
            <div style="text-align:right">
              <div class="label">Planet</div>
              <div class="big" id="planetName">—</div>
              <div class="small" id="planetSummary">—</div>
            </div>
          </div>

          <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

          <div class="stats">
            <div class="item">
              <div class="label">Orbital Radius</div>
              <div id="orbital" class="big">—</div>
            </div>
            <div class="item">
              <div class="label">Surface Gravity</div>
              <div id="gravity" class="big">—</div>
            </div>
            <div class="item">
              <div class="label">Mean Temperature</div>
              <div id="temperature" class="big">—</div>
            </div>
            <div class="item">
              <div class="label">Surface Pressure</div>
              <div id="pressure" class="big">—</div>
            </div>
            <div class="item">
              <div class="label">Wind (peak)</div>
              <div id="wind" class="big">—</div>
            </div>
            <div class="item">
              <div class="label">Cloud Coverage</div>
              <div id="clouds" class="big">—</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="label">Atmospheric Composition</div>
            <div id="composition" class="composition"></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
            <div class="pill" id="habitabilityPill">—</div>
            <div class="small" id="habitabilityReason">—</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="label">Notable Weather & Phenomena</div>
          <div id="phenomena" class="small" style="margin-top:8px">—</div>
        </div>
      </div>

      <aside class="rightcol">
        <div class="card">
          <div class="label">System Location</div>
          <div id="location" style="margin-top:8px" class="small">—</div>
          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">
          <div class="label">Diagnostics</div>
          <div class="small" id="diagnostics" style="margin-top:8px">—</div>
        </div>

        <div class="card">
          <div class="label">Visuals</div>
          <div class="visual-tabs" role="tablist">
            <button class="tab active" data-tab="orbit">Orbit</button>
            <button class="tab" data-tab="gauge">Habitability</button>
            <button class="tab" data-tab="facts">Fun Facts</button>
          </div>

          <div id="visualOrbit" class="visual-canvas" style="display:block">
            <!-- orbit svg drawn here -->
            <svg id="orbitSvg" width="300" height="180" viewBox="0 0 300 180" aria-label="Orbit diagram"></svg>
          </div>

          <div id="visualGauge" class="visual-canvas" style="display:none;flex-direction:column;gap:8px">
            <div id="gaugeContainer" class="gauge" aria-hidden="false"></div>
            <div class="small" id="gaugeText">—</div>
          </div>

          <div id="visualFacts" style="display:none">
            <div class="label" style="margin-top:6px">Quick Facts</div>
            <div id="funfacts" class="funfacts" style="margin-top:8px">—</div>
          </div>
        </div>

        <div class="card">
          <div class="label">Saved Thumbnails</div>
          <div id="thumbGrid" class="thumb-grid">
            <!-- thumbnails -->
          </div>
        </div>
      </aside>
    </div>

    <div class="footer">
      Tip: toggle "Current Earth Conditions" to inspect a stable, livable report for comparison. Use "Show °C" to view temperatures in Celsius.
    </div>
  </div>

<script>
(function(){
  // Utility
  const qs = s => document.querySelector(s);
  const rand = (min,max) => Math.random() * (max-min) + min;
  const randint = (min,max) => Math.floor(rand(min,max+1));
  const choice = arr => arr[Math.floor(Math.random()*arr.length)];
  const toC = f => +(((f - 32) * 5/9)).toFixed(1);
  const toF = c => +((c * 9/5) + 32).toFixed(1);

  // Templates & pools
  const starClasses = ['O','B','A','F','G','K','M'];
  const luminosity = ['I','II','III','IV','V'];
  const phenomenaPool = [
    "Global dust storms", "Auroral curtains", "Methane rain", "Silicate particulates in atmosphere",
    "Supersonic jet streams", "Persistent lightning storms", "High-altitude hydrocarbons haze",
    "Cryovolcanic plumes", "Magnetospheric radiation belts", "Dense smog and photochemical haze",
    "Seasonal polar caps", "Thick sulfuric clouds", "Transient water vapor plumes"
  ];

  // DOM
  const el = {
    systemName: qs('#systemName'),
    starInfo: qs('#starInfo'),
    planetName: qs('#planetName'),
    planetSummary: qs('#planetSummary'),
    orbital: qs('#orbital'),
    gravity: qs('#gravity'),
    temperature: qs('#temperature'),
    pressure: qs('#pressure'),
    wind: qs('#wind'),
    clouds: qs('#clouds'),
    composition: qs('#composition'),
    habitabilityPill: qs('#habitabilityPill'),
    habitabilityReason: qs('#habitabilityReason'),
    phenomena: qs('#phenomena'),
    location: qs('#location'),
    diagnostics: qs('#diagnostics'),
    shuffle: qs('#shuffle'),
    earthToggle: qs('#earthToggle'),
    unitToggle: qs('#unitToggle'),
    findHabitable: qs('#findHabitable'),
    orbitSvg: qs('#orbitSvg'),
    visualTabs: Array.from(document.querySelectorAll('.tab')),
    visualOrbit: qs('#visualOrbit'),
    visualGauge: qs('#visualGauge'),
    visualFacts: qs('#visualFacts'),
    gaugeContainer: qs('#gaugeContainer'),
    gaugeText: qs('#gaugeText'),
    funfacts: qs('#funfacts'),
    saveFavorite: qs('#saveFavorite'),
    saveNote: qs('#saveNote'),
    planetNameInput: qs('#planetNameInput'),
    generateThumb: qs('#generateThumb'),
    downloadThumb: qs('#downloadThumb'),
    thumbGrid: qs('#thumbGrid'),
  };

  // Keep last dataset to allow re-render when switching units
  let lastDataset = null;
  // displayUnit: 'F' (default) or 'C'
  let displayUnit = 'F';
  // Searching state
  let searching = false;
  // last thumbnail
  let lastThumbnailDataUrl = null;

  // Random generators
  function makeSystemName(){
    if(Math.random() < 0.25){
      return choice(['Kepler','TRAPPIST','Gliese','HD','KIC']) + '-' + randint(10,9999);
    }
    const a = String.fromCharCode(65 + randint(0,25));
    const b = String.fromCharCode(65 + randint(0,25));
    const digits = randint(10,999);
    return `${a}${b}-${digits}`;
  }

  function makeStar(){
    const cls = choice(starClasses);
    const sub = randint(0,9);
    const lum = choice(luminosity);
    const name = `${cls}${sub}${lum}`;
    const type = (() => {
      if (cls==='O' || cls==='B') return 'Massive luminous';
      if (cls==='A' || cls==='F') return 'Hot luminous';
      if (cls==='G') return 'Yellow dwarf (G-type)';
      if (cls==='K') return 'Orange dwarf (K-type)';
      return 'Red dwarf (M-type)';
    })();
    const luminosityFactor = ({O:50000,B:1000,A:20,F:6,G:1,K:0.4,M:0.04})[cls] || 1;
    return {name, type, cls, sub, lum, luminosityFactor};
  }

  function makePlanet(systemName, star){
    const index = randint(1,12);
    const base = Math.pow(1.5, index-1) * 0.35;
    const orbital = +(base * (0.7 + Math.random()*0.6)).toFixed(2);
    const sizeCategory = Math.random();
    let radiusEarth, massEarth, pType;
    if(sizeCategory < 0.25){
      pType = 'Terrestrial'; radiusEarth = +(rand(0.3,1.2).toFixed(2)); massEarth = +(Math.pow(radiusEarth,3) * (0.7 + Math.random()*1.3)).toFixed(2);
    } else if(sizeCategory < 0.45){
      pType = 'Super-Earth'; radiusEarth = +(rand(1.3,2.4).toFixed(2)); massEarth = +(rand(2,10).toFixed(2));
    } else if(sizeCategory < 0.7){
      pType = 'Sub-Neptune'; radiusEarth = +(rand(2.5,4.0).toFixed(2)); massEarth = +(rand(10,40).toFixed(2));
    } else {
      pType = 'Gas Giant'; radiusEarth = +(rand(4.0,11.0).toFixed(2)); massEarth = +(rand(50,600).toFixed(0));
    }
    const gravity = +(massEarth / (radiusEarth*radiusEarth)).toFixed(2);

    // Temperature: compute via Kelvin then convert to C and F; store both
    let tempK = 278 * Math.pow(star.luminosityFactor, 0.25) / Math.sqrt(Math.max(orbital,0.2));
    tempK = tempK * (0.6 + Math.random()*1.8);
    const tempC = +(tempK - 273.15).toFixed(1);
    const tempF = +((tempC * 9/5) + 32).toFixed(1);

    let pressure = +(Math.pow(Math.random(), 2) * 150).toFixed(2);
    if(pType === 'Terrestrial' && Math.random() < 0.6) pressure = +(pressure * 0.02 + 0.6).toFixed(2);
    if(pType.includes('Gas')) pressure = +(rand(50,300).toFixed(2));

    const comp = buildComposition(pType, tempF, tempC);

    const clouds = +(Math.min(100, Math.max(0, (comp.some(g=>g.gas==='H2O')? randint(10,90) : randint(0,95)) ))).toFixed(0);
    const wind = (pType.includes('Gas') ? randint(100,1200) : randint(0,250));
    const phenomena = generatePhenomena(pType, tempF, pressure, comp);

    const habitability = evaluateHabitability({tempF, tempC, pressure, comp, gravity, pType});

    const planetLetter = String.fromCharCode(98 + Math.min(25, index));
    const planetCode = `${systemName.split('-')[0]}-${String(index).padStart(2,'0')}${planetLetter}`;

    return {
      systemName,
      planetCode,
      index,
      orbitalAU: orbital,
      radiusEarth,
      massEarth,
      gravity,
      tempF,
      tempC,
      pressureBar: +pressure,
      composition: comp,
      cloudsPercent: clouds,
      windKph: wind,
      type: pType,
      phenomena,
      habitability
    };
  }

  function buildComposition(pType, tempF, tempC){
    const comps = [];
    if(pType.includes('Gas')){
      comps.push({gas:'H2',pct: +(rand(60,92)).toFixed(1)});
      comps.push({gas:'He',pct: +(rand(6,30)).toFixed(1)});
      if(Math.random() < 0.4) comps.push({gas:'CH4',pct: +(rand(0.1,4)).toFixed(2)});
    } else {
      let n2 = +(rand(30,90)).toFixed(1);
      let o2 = +(rand(0,30)).toFixed(1);
      let co2 = +(rand(0,10)).toFixed(2);
      // Bias for habitable-like mixes using Fahrenheit range roughly equivalent to original C bias
      if(tempF >= -13 && tempF <= 131 && Math.random() < 0.5){
        n2 = +(rand(60,80)).toFixed(1);
        o2 = +(rand(10,25)).toFixed(1);
        co2 = +(rand(0.01,0.8)).toFixed(2);
      }
      comps.push({gas:'N2',pct:n2});
      if(o2>0.05) comps.push({gas:'O2',pct:o2});
      if(co2>0.01) comps.push({gas:'CO2',pct:co2});
      if(Math.random() < 0.4) comps.push({gas:'Ar',pct: +(rand(0.1,1.2)).toFixed(2)});
      if(Math.random() < 0.35) comps.push({gas:'CH4',pct: +(rand(0,2)).toFixed(2)});
      if(Math.random() < 0.35) comps.push({gas:'H2O',pct: +(rand(0,6)).toFixed(2)});
      if(Math.random() < 0.12) comps.push({gas:'SO2',pct: +(rand(0,4)).toFixed(2)});
    }
    let sum = comps.reduce((s,c)=>s+Number(c.pct),0);
    if(sum < 30 && pType.includes('Gas')) sum = comps.reduce((s,c)=>s+Number(c.pct),0);
    comps.forEach(c => { c.pct = +(100 * c.pct / sum).toFixed(2); });
    return comps.sort((a,b)=>b.pct - a.pct);
  }

  function generatePhenomena(type, tempF, pressure, composition){
    const pool = [];
    if(type.includes('Gas')){
      pool.push("High-altitude banded storms");
      pool.push("Strong magnetospheric radio emissions");
    } else {
      if(composition.some(g=>g.gas==='CH4' && g.pct>1)) pool.push("Hydrocarbon haze and orange skies");
      if(composition.some(g=>g.gas==='SO2')) pool.push("Acidic cloud layers and sulfuric aerosols");
      if(Math.abs(tempF) < 212 && Math.random() < 0.5) pool.push("Seasonal storms and weather fronts");
      if(pressure > 50) pool.push("Supercritical atmospheric phenomena");
      if(Math.random() < 0.2) pool.push(choice(phenomenaPool));
    }
    if(pool.length === 0) pool.push(choice(phenomenaPool));
    return pool;
  }

  function evaluateHabitability({tempF, tempC, pressure, comp, gravity, pType}){
    // Heuristic uses Fahrenheit bounds internally
    let score = 0;
    if(pType==='Terrestrial' || pType==='Super-Earth' || pType==='Ocean World') score += 1;
    if(tempF >= -4 && tempF <= 122) score += 2;
    if(pressure >= 0.4 && pressure <= 5) score += 2;
    const o2 = (comp.find(c=>c.gas==='O2')||{pct:0}).pct;
    if(o2 >= 18 && o2 <= 25) score += 2;
    const toxic = (comp.find(c=>c.gas==='SO2')||{pct:0}).pct + (comp.find(c=>c.gas==='CH4')||{pct:0}).pct*0.2;
    if(toxic < 5) score += 1;
    if(gravity >= 0.5 && gravity <= 2.5) score += 1;

    const reasons = [];
    if(score >= 7) reasons.push("Conditions compatible with surface life and human habitability (within rough heuristic).");
    else {
      if(!(pType==='Terrestrial' || pType==='Super-Earth' || pType==='Ocean World')) reasons.push("Planet type unlikely for terrestrial habitability.");
      if(!(tempF >= -4 && tempF <= 122)) reasons.push(`Temperature (${tempF}°F) outside comfortable range.`);
      if(!(pressure >= 0.4 && pressure <= 5)) reasons.push(`Pressure (${pressure} bar) outside habitable window.`);
      if(!(o2 >= 18 && o2 <= 25)) reasons.push("Oxygen concentration not suitable for Earth-like respiration.");
      if(toxic >= 5) reasons.push("Toxic trace gases may be hazardous.");
      if(!(gravity >= 0.5 && gravity <= 2.5)) reasons.push("Gravity outside comfortable human tolerance.");
    }

    return {
      score,
      habitable: score >= 7,
      reasons
    };
  }

  function setEarth(){
    const systemName = 'Sol';
    const star = {name:'Sun (G2V)', type:'G2V', luminosityFactor:1, cls:'G', sub:2, lum:'V'};
    const planet = {
      systemName,
      planetCode: 'Sol-01b',
      index: 3,
      orbitalAU: 1.00,
      radiusEarth: 1.0,
      massEarth: 1.0,
      gravity: 1.0,
      tempF: 59.0,
      tempC: 15.0,
      pressureBar: 1.013,
      composition: [
        {gas:'N2',pct:78.08},
        {gas:'O2',pct:20.95},
        {gas:'Ar',pct:0.93},
        {gas:'CO2',pct:0.04},
        {gas:'CH4',pct:0.00018}
      ],
      cloudsPercent: 60,
      windKph: 110,
      type: 'Terrestrial',
      phenomena: ['Stable climate; seasonal variations; aurora in polar regions'],
      habitability: {score:10, habitable:true, reasons:['Local conditions are stable and livable (reference Earth).']}
    };
    return {star,planet};
  }

  // Convert any temperature mentions in habitability reasons to display unit
  function convertReasonsToDisplayUnit(reasons, unit){
    return reasons.map(r => {
      return r.replace(/(-?\d+(\.\d+)?)°([FC])/g, (m, num, dec, u) => {
        const n = parseFloat(num);
        if(unit === 'F'){
          if(u === 'F') return `${n}°F`;
          return `${toF(n)}°F`;
        } else {
          if(u === 'C') return `${n}°C`;
          return `${toC(n)}°C`;
        }
      });
    });
  }

  function render(dataset){
    if(!dataset) return;
    lastDataset = dataset; // save for unit toggling
    const star = dataset.star;
    const planet = dataset.planet;
    const customName = el.planetNameInput.value.trim();

    el.systemName.textContent = planet.systemName || star.name || '—';
    el.starInfo.textContent = `${star.name} • ${star.type || '='}`;
    el.planetName.textContent = customName || planet.planetCode;
    el.planetSummary.textContent = `${planet.type} • ${planet.radiusEarth} R⊕ • ${planet.massEarth} M⊕`;
    el.orbital.textContent = `${planet.orbitalAU} AU (index ${planet.index})`;
    el.gravity.textContent = `${planet.gravity} g`;

    // Temperature display based on unit toggle
    const tempDisplay = (displayUnit === 'F') ? `${planet.tempF} °F` : `${planet.tempC} °C`;
    el.temperature.textContent = tempDisplay;

    el.pressure.textContent = `${planet.pressureBar} bar`;
    el.wind.textContent = `${planet.windKph} km/h`;
    el.clouds.textContent = `${planet.cloudsPercent} %`;

    // Composition UI
    el.composition.innerHTML = '';
    planet.composition.slice(0,8).forEach(comp=>{
      const row = document.createElement('div');
      row.className = 'comp-row';
      row.innerHTML = `<div>${comp.gas}</div><div>${comp.pct}%</div>`;
      const barWrap = document.createElement('div');
      barWrap.className = 'bar';
      const bar = document.createElement('i');
      bar.style.width = Math.max(2, Math.min(100, comp.pct)) + '%';
      barWrap.appendChild(bar);
      el.composition.appendChild(row);
      el.composition.appendChild(barWrap);
    });

    // Habitability - convert reasons to display unit
    const reasons = planet.habitability.reasons || [];
    const displayReasons = convertReasonsToDisplayUnit(reasons, displayUnit);
    el.habitabilityPill.textContent = planet.habitability.habitable ? 'LIVABLE' : 'UNSUITABLE';
    el.habitabilityPill.className = 'pill ' + (planet.habitability.habitable ? 'good' : 'bad');
    el.habitabilityReason.textContent = (planet.habitability.habitable ? displayReasons.join(' ') : displayReasons.slice(0,3).join(' '));

    el.phenomena.textContent = planet.phenomena.join('; ');
    el.location.textContent = `≈ Sector ${makeCoordinate()} • System ${planet.systemName} • Star class ${star.cls}${star.sub}${star.lum}`;
    el.diagnostics.textContent = `Generated ${new Date().toISOString()}`;

    // Visuals
    drawOrbit(planet, star);
    drawGauge(planet.habitability.score);
    populateFunFacts(planet, star);

    // reset last thumbnail until generateThumbnail is run
    lastThumbnailDataUrl = null;
  }

  function makeCoordinate(){
    const x = randint(-1200,1200);
    const y = randint(-1200,1200);
    const z = randint(-1200,1200);
    return `${x}, ${y}, ${z}`;
  }

  // Orbit drawing: simple star center + scaled orbit circle + planet dot
  function drawOrbit(planet, star){
    const svg = el.orbitSvg;
    while(svg.firstChild) svg.removeChild(svg.firstChild);
    const w = svg.viewBox.baseVal.width || 300;
    const h = svg.viewBox.baseVal.height || 180;
    const cx = w/2;
    const cy = h/2;

    // star
    const starEl = document.createElementNS('http://www.w3.org/2000/svg','circle');
    starEl.setAttribute('cx', cx);
    starEl.setAttribute('cy', cy);
    starEl.setAttribute('r', 8);
    starEl.setAttribute('fill', '#ffd97a');
    svg.appendChild(starEl);

    // orbit radius scaled by orbitalAU
    const maxAU = 5; // visual scale
    const r = Math.min((Math.max(planet.orbitalAU,0.1)/maxAU) * (Math.min(cx,cy)-20) + 30, Math.min(cx,cy)-10);
    const orbitEl = document.createElementNS('http://www.w3.org/2000/svg','ellipse');
    orbitEl.setAttribute('cx', cx);
    orbitEl.setAttribute('cy', cy);
    orbitEl.setAttribute('rx', r);
    orbitEl.setAttribute('ry', r*0.6);
    orbitEl.setAttribute('fill', 'none');
    orbitEl.setAttribute('stroke', 'rgba(255,255,255,0.04)');
    orbitEl.setAttribute('stroke-dasharray', '3 4');
    svg.appendChild(orbitEl);

    // planet position (angle based on index)
    const angle = (planet.index / 12) * Math.PI*2;
    const px = cx + r * Math.cos(angle);
    const py = cy + r*0.6 * Math.sin(angle);

    const planetSize = Math.max(3, Math.min(18, planet.radiusEarth * 3));
    const pEl = document.createElementNS('http://www.w3.org/2000/svg','circle');
    pEl.setAttribute('cx', px);
    pEl.setAttribute('cy', py);
    pEl.setAttribute('r', planetSize);
    pEl.setAttribute('fill', planet.type.includes('Gas') ? '#85c1ff' : '#6ee7b7');
    pEl.setAttribute('stroke', 'rgba(0,0,0,0.2)');
    svg.appendChild(pEl);

    const label = document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('x', px + planetSize + 6);
    label.setAttribute('y', py + 4);
    label.setAttribute('fill', '#bfe6ff');
    label.setAttribute('font-size', '12');
    // Use the displayed UI name so label always matches the main section
    label.textContent = el.planetName.textContent || planet.planetCode;
    svg.appendChild(label);
  }

  // Habitability gauge using SVG circle
  function drawGauge(score){
    const max = 10;
    const pct = Math.max(0, Math.min(1, score / max));
    const size = 120;
    const stroke = 12;
    const r = (size - stroke)/2;
    const c = 2 * Math.PI * r;
    const filled = c * pct;
    const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('width', size);
    svg.setAttribute('height', size);
    svg.setAttribute('viewBox', `0 0 ${size} ${size}`);
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.setAttribute('transform', `translate(${size/2},${size/2})`);
    // background circle
    const bg = document.createElementNS('http://www.w3.org/2000/svg','circle');
    bg.setAttribute('r', r);
    bg.setAttribute('fill', 'none');
    bg.setAttribute('stroke', 'rgba(255,255,255,0.04)');
    bg.setAttribute('stroke-width', stroke);
    g.appendChild(bg);
    // foreground
    const fg = document.createElementNS('http://www.w3.org/2000/svg','circle');
    fg.setAttribute('r', r);
    fg.setAttribute('fill', 'none');
    fg.setAttribute('stroke', pct > 0.66 ? '#6ee7b7' : (pct > 0.33 ? '#ffd97a' : '#ff7b7b'));
    fg.setAttribute('stroke-width', stroke);
    fg.setAttribute('stroke-linecap', 'round');
    fg.setAttribute('stroke-dasharray', `${filled} ${c - filled}`);
    fg.setAttribute('stroke-dashoffset', '0');
    // rotate only the foreground arc so the arc starts at top, but text remains upright
    fg.setAttribute('transform', 'rotate(-90)');
    g.appendChild(fg);
    // center text
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', 0);
    t.setAttribute('y', 6);
    t.setAttribute('text-anchor', 'middle');
    t.setAttribute('fill', '#bfe6ff');
    t.setAttribute('font-size', '18');
    t.setAttribute('font-weight', '700');
    t.textContent = `${Math.round(pct*100)}%`;
    g.appendChild(t);

    svg.appendChild(g);
    el.gaugeContainer.innerHTML = '';
    el.gaugeContainer.appendChild(svg);
    el.gaugeText.textContent = `Score: ${score}/10 — ${score >= 7 ? 'Likely habitable' : 'Not habitable (by heuristic)'}`;
  }

  function populateFunFacts(planet, star){
    const facts = [];
    facts.push(`Star: ${star.name} (${star.cls}${star.sub}${star.lum})`);
    facts.push(`Type: ${planet.type} • ${planet.radiusEarth} R⊕ • ${planet.massEarth} M⊕`);
    const tempString = displayUnit === 'F' ? `${planet.tempF} °F` : `${planet.tempC} °C`;
    facts.push(`Mean Temperature: ${tempString}`);
    facts.push(`Pressure: ${planet.pressureBar} bar • Clouds: ${planet.cloudsPercent}%`);
    // pick up to 2 notable composition entries
    const topGases = planet.composition.slice(0,2).map(g => `${g.gas} ${g.pct}%`).join(', ');
    facts.push(`Main gases: ${topGases}`);
    if(planet.phenomena && planet.phenomena.length) facts.push(`Notables: ${planet.phenomena[0]}`);
    el.funfacts.textContent = facts.join('\n');
  }

  // --- Thumbnail generation ---
  // create a compact canvas thumbnail (data URL)
  function generateThumbnail(dataset, size = 300){
    if(!dataset) return null;
    const star = dataset.star;
    const planet = dataset.planet;
    // offscreen canvas
    const cvs = document.createElement('canvas');
    cvs.width = size;
    cvs.height = size;
    const ctx = cvs.getContext('2d');

    // background gradient
    const g = ctx.createLinearGradient(0,0,0,size);
    g.addColorStop(0, '#071025');
    g.addColorStop(1, '#021021');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,size,size);

    // star (center-left)
    const cx = size * 0.35;
    const cy = size * 0.45;
    ctx.beginPath();
    ctx.fillStyle = '#ffd97a';
    ctx.arc(cx, cy, Math.max(6, size*0.04), 0, Math.PI*2);
    ctx.fill();

    // orbit ellipse
    const r = size * (0.25 + Math.min(planet.orbitalAU / 5, 0.6) * 0.35);
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 2;
    ctx.setLineDash([4,6]);
    ctx.beginPath();
    ctx.ellipse(cx, cy, r, r*0.6, 0, 0, Math.PI*2);
    ctx.stroke();
    ctx.setLineDash([]);

    // planet position (angle from index)
    const angle = (planet.index/12) * Math.PI*2;
    const px = cx + r*Math.cos(angle);
    const py = cy + r*0.6*Math.sin(angle);
    // planet color
    const pColor = planet.type.includes('Gas') ? '#85c1ff' : '#6ee7b7';
    const pSize = Math.max(6, Math.min(40, planet.radiusEarth * 6));
    // glow for gas giants
    if(planet.type.includes('Gas')){
      const rad = pSize * 1.8;
      const lg = ctx.createRadialGradient(px,py,0,px,py,rad);
      lg.addColorStop(0, pColor);
      lg.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = lg;
      ctx.beginPath();
      ctx.arc(px,py,rad,0,Math.PI*2);
      ctx.fill();
    }
    ctx.fillStyle = pColor;
    ctx.beginPath();
    ctx.arc(px,py,pSize,0,Math.PI*2);
    ctx.fill();

    // use the displayed UI name (authoritative)
    const displayName = el.planetName.textContent || planet.planetCode;
    ctx.fillStyle = 'rgba(191,230,255,0.9)';
    ctx.font = `${Math.max(10, size*0.04)}px Inter, sans-serif`;
    ctx.textAlign = 'left';
    ctx.fillText(displayName, Math.max(px + pSize + 6, 12), Math.min(py + 6, size - 12));

    // bottom info bar
    ctx.fillStyle = 'rgba(255,255,255,0.03)';
    ctx.fillRect(0, size - 48, size, 48);
    ctx.fillStyle = '#bfe6ff';
    ctx.font = `${Math.max(10, size*0.038)}px Inter, sans-serif`;
    ctx.textAlign = 'center';
    const tempString = displayUnit === 'F' ? `${planet.tempF}°F` : `${planet.tempC}°C`;
    ctx.fillText(`${planet.type} • ${tempString} • ${planet.habitability.habitable ? 'LIVABLE' : 'UNSUITABLE'}`, size/2, size - 20);

    // result
    return cvs.toDataURL('image/png');
  }

  function downloadCurrentThumbnail(){
    if(!lastThumbnailDataUrl && lastDataset){
      lastThumbnailDataUrl = generateThumbnail(lastDataset, 600);
    }
    if(!lastThumbnailDataUrl) {
      alert('No thumbnail available. Generate one first.');
      return;
    }
    const a = document.createElement('a');
    a.href = lastThumbnailDataUrl;
    const name = (el.planetName.textContent.trim() || (lastDataset && lastDataset.planet.planetCode) || 'planet').replace(/\s+/g,'_');
    a.download = `${name}_thumbnail.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // Save favorite includes thumbnail and uses displayed name
  function saveFavorite(){
    if(!lastDataset) return;
    // ensure we have a thumbnail
    if(!lastThumbnailDataUrl){
      lastThumbnailDataUrl = generateThumbnail(lastDataset, 300);
    }
    const displayName = (el.planetName.textContent || lastDataset.planet.planetCode || '').trim();
    const entry = {
      id: `${lastDataset.planet.planetCode}-${Date.now()}`,
      name: displayName || (el.planetNameInput.value.trim() || lastDataset.planet.planetCode),
      created: new Date().toISOString(),
      star: lastDataset.star,
      planet: lastDataset.planet,
      thumbnail: lastThumbnailDataUrl
    };
    const existing = JSON.parse(localStorage.getItem('pb_favorites') || '[]');
    existing.push(entry);
    localStorage.setItem('pb_favorites', JSON.stringify(existing));
    el.saveNote.textContent = `Saved as favorite (${entry.name})`;
    renderGallery();
    setTimeout(()=> el.saveNote.textContent = '', 3000);
  }

  function renderGallery(){
    const list = JSON.parse(localStorage.getItem('pb_favorites') || '[]');
    el.thumbGrid.innerHTML = '';
    list.slice().reverse().forEach(item=>{
      const d = document.createElement('div');
      d.className = 'thumb';
      const img = document.createElement('img');
      img.src = item.thumbnail;
      img.alt = item.name;
      d.appendChild(img);
      d.title = `${item.name}\n${new Date(item.created).toLocaleString()}`;
      d.addEventListener('click', ()=>{
        // clicking thumbnail loads that planet into the UI
        render({star: item.star, planet: item.planet});
        // also set the planetNameInput to the saved display name for clarity
        el.planetNameInput.value = item.name;
      });
      el.thumbGrid.appendChild(d);
    });
  }

  // Main actions
  function randomize(){
    if(el.earthToggle.checked){
      const {star,planet} = setEarth();
      render({star,planet});
      return;
    }
    const systemName = makeSystemName();
    const star = makeStar();
    const planet = makePlanet(systemName, star);
    render({star,planet});
  }

  // Find habitable implementation (asynchronous to avoid freezing UI)
  async function findHabitable(){
    if(searching) return;
    searching = true;

    // Save current states to restore later
    const prevEarth = el.earthToggle.checked;
    // Disable earthToggle during search to avoid collision
    el.earthToggle.checked = false;

    // Disable controls while searching
    el.shuffle.disabled = true;
    el.findHabitable.disabled = true;
    el.unitToggle.disabled = true;
    el.earthToggle.disabled = true;
    el.generateThumb.disabled = true;
    el.downloadThumb.disabled = true;
    el.saveFavorite.disabled = true;

    const maxAttempts = 5000;
    const chunkSize = 100; // process in chunks then yield
    let attempts = 0;
    el.diagnostics.textContent = `Searching for habitable planet...`;

    while(attempts < maxAttempts){
      for(let i=0;i<chunkSize && attempts < maxAttempts;i++){
        attempts++;
        const systemName = makeSystemName();
        const star = makeStar();
        const planet = makePlanet(systemName, star);
        if(planet.habitability.habitable){
          render({star,planet});
          el.diagnostics.textContent = `Found habitable after ${attempts} attempts • ${new Date().toISOString()}`;
          // restore toggles & controls
          el.shuffle.disabled = false;
          el.findHabitable.disabled = false;
          el.unitToggle.disabled = false;
          el.earthToggle.disabled = false;
          el.generateThumb.disabled = false;
          el.downloadThumb.disabled = false;
          el.saveFavorite.disabled = false;
          el.earthToggle.checked = prevEarth;
          searching = false;
          return;
        }
      }
      // update diagnostics and yield to the UI
      el.diagnostics.textContent = `Searching for habitable planet... attempts: ${attempts}`;
      // short pause to keep UI responsive
      // eslint-disable-next-line no-await-in-loop
      await new Promise(r => setTimeout(r, 0));
    }

    // If we reach here, no habitable planet found within attempt limit
    el.diagnostics.textContent = `No habitable planet found after ${attempts} attempts. Try increasing maxAttempts.`;
    // restore toggles & controls
    el.shuffle.disabled = false;
    el.findHabitable.disabled = false;
    el.unitToggle.disabled = false;
    el.earthToggle.disabled = false;
    el.generateThumb.disabled = false;
    el.downloadThumb.disabled = false;
    el.saveFavorite.disabled = false;
    el.earthToggle.checked = prevEarth;
    searching = false;
  }

  // Tab switching for visuals
  el.visualTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      el.visualTabs.forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      const tabName = tab.dataset.tab;
      el.visualOrbit.style.display = tabName === 'orbit' ? 'flex' : 'none';
      el.visualGauge.style.display = tabName === 'gauge' ? 'flex' : 'none';
      el.visualFacts.style.display = tabName === 'facts' ? 'block' : 'none';
    });
  });

  // Thumbnail controls
  el.generateThumb.addEventListener('click', ()=>{
    if(!lastDataset){
      alert('Generate or load a planet first.');
      return;
    }
    lastThumbnailDataUrl = generateThumbnail(lastDataset, 600);
    el.saveNote.textContent = 'Thumbnail generated';
    setTimeout(()=> el.saveNote.textContent = '', 1800);
  });

  el.downloadThumb.addEventListener('click', ()=>{
    downloadCurrentThumbnail();
  });

  el.saveFavorite.addEventListener('click', ()=> saveFavorite());

  el.unitToggle.addEventListener('change', ()=>{
    displayUnit = el.unitToggle.checked ? 'C' : 'F';
    render(lastDataset);
  });

  el.shuffle.addEventListener('click', ()=> randomize());
  el.earthToggle.addEventListener('change', ()=> randomize());
  el.findHabitable.addEventListener('click', ()=> findHabitable());

  // Initial generation
  randomize();
  renderGallery();

})();
</script>
</body>
</html>
