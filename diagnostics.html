<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Diagnostics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="app.css" />
  <style>
    :root {
      --bg-dark: #0f1116;
      --bg-panel: #151722;
      --accent: #4fd1c5;
      --accent-2: #6ee7d7;
      --text-main: #e6eef3;
      --text-muted: #9aa6b4;
      --border: #222734;
      --danger: #ff6b6b;
      --success: #4ade80;
      --warning: #f6c94d;
      --font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      --glass: rgba(255,255,255,0.03);
    }

    /* Base layout */
    body {
      margin: 0;
      font-family: var(--font-family);
      color: var(--text-main);
      background: linear-gradient(180deg, #07080b 0%, #0b0f14 100%);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height: 100vh;
    }
    header.site-header {
      background:
        radial-gradient(600px 120px at 10% 30%, rgba(127,240,223,0.06), transparent 8%),
        radial-gradient(500px 100px at 90% 60%, rgba(79,209,197,0.04), transparent 6%),
        linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      border-bottom: 2px solid rgba(79,209,197,0.12);
      padding: 12px 18px;
    }
    .header-inner {
      max-width: 1100px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin: 0 auto;
      padding: 8px 6px;
    }
    .header-left { 
      display: flex; 
      gap: 14px; 
      align-items: center; 
    }
    .site-emblem {
      width: 60px;
      height: 60px;
      flex: 0 0 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(127,240,223,0.06), rgba(79,209,197,0.02));
      border: 1px solid rgba(127,240,223,0.08);
      box-shadow: 0 6px 20px rgba(0,0,0,0.5), 0 0 30px rgba(79,209,197,0.02) inset;
    }
    .site-emblem img { 
      width: 42px; 
      height: 42px; 
      border-radius: 8px; 
      display: block;
      object-fit: contain;
    }
    .header-text h1 { 
      margin: 0; 
      font-size: 1.3rem; 
      color: var(--text-main);
      letter-spacing: 1.2px;
      font-weight: 800;
    }
    .header-text h2 { 
      margin: 4px 0 0 0; 
      color: var(--text-muted); 
      font-size: 0.9rem; 
      font-weight: 700;
      letter-spacing: 0.6px;
    }
    .return-command-hub {
      background: var(--accent);
      color: var(--bg-panel);
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 700;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .return-command-hub:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }

    main {
      max-width: 980px;
      margin: 1.75rem auto;
      padding: 1.25rem;
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 1rem;
      align-items: start;
    }

    /* Left column (controls) */
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius: 12px;
      padding: 1rem;
      border: 1px solid var(--border);
      box-shadow: 0 6px 24px rgba(0,0,0,0.55);
    }

    .diagnostics-select {
      display:flex;
      flex-direction:column;
      gap:0.55rem;
      margin-bottom: 0.85rem;
      max-height: calc(100vh - 240px);
      overflow:auto;
      padding-right: 6px;
    }
    .diagnostics-select button {
      display:flex;
      align-items:center;
      gap:0.6rem;
      background:var(--glass);
      color:var(--text-main);
      border:1px solid rgba(255,255,255,0.03);
      padding:0.6rem 0.8rem;
      border-radius:8px;
      font-size:0.98rem;
      cursor:pointer;
      transition: transform 0.12s ease, background 0.12s ease;
      text-align:left;
    }
    .diagnostics-select button:focus { outline: 2px solid rgba(79,209,197,0.18); outline-offset:2px; }
    .diagnostics-select button:hover { transform: translateY(-2px); }
    .diagnostics-select button.selected {
      background: linear-gradient(90deg, rgba(79,209,197,0.06), rgba(79,209,197,0.02));
      border: 1px solid rgba(79,209,197,0.12);
      box-shadow: 0 6px 18px rgba(79,209,197,0.02);
    }
    .btn-icon {
      width:12px; height:12px; border-radius:50%; background:var(--warning); box-shadow: inset 0 -2px 0 rgba(0,0,0,0.35);
    }

    /* Right column (details) */
    .details {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005));
      border-radius:12px;
      padding:1rem;
      border:1px solid var(--border);
      min-height:240px;
    }

    .header-row {
      display:flex;
      gap:1rem;
      align-items:center;
      justify-content:space-between;
      margin-bottom:0.8rem;
    }
    .diagnostics-area { font-size:1.1rem; color:var(--accent-2); text-align:left; margin:0; }
    .diagnostics-error {
      background:#0b0e13;
      color:var(--danger);
      border-radius:8px;
      padding:0.75rem;
      margin-bottom:0.7rem;
      font-size:1rem;
      border:1px solid rgba(255,0,0,0.06);
      min-height:2.2em;
    }
    .diagnostics-nominal {
      color:var(--success);
      border-color: rgba(74,222,128,0.08);
    }
    /* default to neutral color; color will be set dynamically based on state */
    .diagnostics-status { font-size:0.98rem; margin-bottom:0.6rem; min-height:1.4em; color:var(--text-muted); }

    .status-row { display:flex; gap:0.75rem; align-items:center; }
    .status-led { width:12px; height:12px; border-radius:50%; background:#2b2f34; box-shadow:0 2px 6px rgba(0,0,0,0.6) inset; transition: background 220ms, box-shadow 220ms; }
    .status-label { font-size:0.95rem; color:var(--text-muted); }

    .diagnostics-fix-btn {
      background:var(--accent);
      color:var(--bg-dark);
      border:none;
      border-radius:8px;
      padding:0.55rem 0.9rem;
      cursor:pointer;
      font-weight:600;
      margin-left:auto;
    }
    .secondary-btn {
      background:transparent;
      border:1px solid rgba(255,255,255,0.04);
      color:var(--text-muted);
      padding:0.45rem 0.65rem;
      border-radius:6px;
      cursor:pointer;
      font-size:0.9rem;
      margin-left:0.4rem;
    }

    .recommendations {
      margin-top:0.8rem;
      background:#07080b;
      border:1px solid rgba(79,209,197,0.08);
      padding:0.8rem;
      border-radius:8px;
      color:var(--text-main);
    }
    .recommendations h3 { margin:0 0 0.45rem 0; color:var(--accent); font-size:0.98rem; text-align:left; }
    .recommendation-list { margin:0; padding-left:1.05rem; color:var(--text-muted); font-size:0.95rem; }
    .recommendation-list li { margin-bottom:0.35rem; }

    .controls-row { display:flex; gap:0.5rem; align-items:center; margin-top:0.6rem; }

    /* Telemetry sparkline */
    .telemetry {
      margin-top:0.6rem;
      display:flex;
      gap:0.6rem;
      align-items:center;
    }
    #telemetryCanvas { background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border-radius:6px; border:1px solid rgba(255,255,255,0.02); }

    /* History list */
    .history {
      margin-top:0.8rem;
      color:var(--text-muted);
      font-size:0.92rem;
    }
    .history-item { padding:0.45rem 0.5rem; border-radius:6px; cursor:pointer; border:1px solid transparent; }
    .history-item:hover { background:rgba(255,255,255,0.01); border-color:rgba(255,255,255,0.02); }

    /* Verbose log */
    .log {
      margin-top:0.6rem;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      color:var(--text-muted);
      font-family: monospace;
      font-size:0.82rem;
      padding:0.6rem;
      border-radius:8px;
      max-height:140px;
      overflow:auto;
      border:1px solid rgba(255,255,255,0.02);
    }

    /* responsive */
    @media (max-width:880px) {
      main { grid-template-columns: 1fr; padding:1rem; margin:1rem; }
    }

    /* Success burst overlay (replaces confetti) */
    .success-burst {
      position: fixed;
      left: 50%;
      top: 18%;
      transform: translateX(-50%) scale(0.95);
      pointer-events: none;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 220px;
      height: 100px;
      opacity: 0;
      transition: opacity 180ms ease, transform 220ms ease;
    }

    .success-burst.show {
      opacity: 1;
      transform: translateX(-50%) scale(1);
    }

    /* radial dots */
    .success-burst .dots {
      position: absolute;
      width: 220px;
      height: 100px;
      top: 0;
      left: 0;
      overflow: visible;
    }
    .success-burst .dot {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      transform-origin: center;
      opacity: 0;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,0.5));
    }

    @keyframes burst {
      0% { transform: translate(0,0) scale(0.6); opacity: 1; }
      60% { opacity: 1; }
      100% { transform: translate(var(--dx), var(--dy)) scale(0.9); opacity: 0; }
    }

    /* checkmark + ring */
    .success-burst .check {
      position: relative;
      z-index: 2;
      width: 72px;
      height: 72px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(79,209,197,0.12), rgba(79,209,197,0.04));
      border: 1px solid rgba(79,209,197,0.12);
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      transform: scale(0.86);
      transition: transform 160ms ease;
    }

    .success-burst.show .check { transform: scale(1); }

    .success-burst .ring {
      position: absolute;
      width: 88px;
      height: 88px;
      border-radius: 50%;
      border: 2px solid rgba(79,209,197,0.12);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      opacity: 0;
      transition: transform 260ms ease, opacity 260ms ease;
    }

    .success-burst.show .ring { transform: translate(-50%, -50%) scale(1); opacity: 1; }

    .success-burst svg.checkmark {
      width: 40px;
      height: 40px;
      stroke: var(--accent-2);
      stroke-width: 4;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      transition: stroke-dashoffset 420ms cubic-bezier(.2,.9,.2,1);
    }
    .success-burst.show svg.checkmark { stroke-dashoffset: 0; }
  </style>
</head>
<body>
  <!-- Shared site header -->
  <header class="site-header">
    <div class="header-inner" role="banner" aria-label="Obsidian Bastion header">
      <div class="header-left">
        <div class="site-emblem" aria-hidden="true" title="Obsidian Bastion emblem">
          <img src="https://obviouslymelissa-hub.github.io/obsidianbastion/images/StrOpBoard.png" alt="Strategic Operations Board">
        </div>
        <div class="header-text" aria-label="Site title">
          <h1>Obsidian Bastion</h1>
          <h2>Diagnostics</h2>
        </div>
      </div>
      <div class="header-right">
        <a href="https://obviouslymelissa-hub.github.io/obsidianbastion/onboardcomputer.html" class="return-command-hub" aria-label="Return to Onboard Computer">← Return</a>
      </div>
    </div>
  </header>

  <main>
    <section class="panel" aria-labelledby="subsystemsHeading">
      <h3 id="subsystemsHeading" style="margin:0 0 0.6rem 0; color:var(--accent)">Subsystems</h3>

      <div class="diagnostics-select" role="tablist" aria-label="Subsystems">
        <button data-area="Life Support" aria-selected="false"> <span class="btn-icon" style="background: #f6c94d;"></span> Life Support</button>
        <button data-area="Power" aria-selected="false"> <span class="btn-icon" style="background: #ffd166;"></span> Power</button>
        <button data-area="Shields" aria-selected="false"> <span class="btn-icon" style="background: #a0e9ff;"></span> Shields</button>
        <button data-area="Navigation" aria-selected="false"> <span class="btn-icon" style="background: #bdb2ff;"></span> Navigation</button>
        <button data-area="Communications" aria-selected="false"> <span class="btn-icon" style="background: #9be7c6;"></span> Communications</button>

        <!-- New systems added -->
        <button data-area="Defense Systems" aria-selected="false"> <span class="btn-icon" style="background: #ff9aa2;"></span> Defense Systems</button>
        <button data-area="Weapons" aria-selected="false"> <span class="btn-icon" style="background: #ffb482;"></span> Weapons</button>
        <button data-area="Point Defense" aria-selected="false"> <span class="btn-icon" style="background: #ffd166;"></span> Point Defense</button>
        <button data-area="ECM" aria-selected="false"> <span class="btn-icon" style="background: #c7f9cc;"></span> Electronic Countermeasures (ECM)</button>
        <button data-area="Sensors" aria-selected="false"> <span class="btn-icon" style="background: #a0e9ff;"></span> Sensors</button>
        <button data-area="Thermal Control" aria-selected="false"> <span class="btn-icon" style="background: #b2d6ff;"></span> Thermal Control</button>
        <button data-area="Hull Integrity" aria-selected="false"> <span class="btn-icon" style="background: #d1d1d1;"></span> Hull Integrity</button>
        <button data-area="Gravity" aria-selected="false"> <span class="btn-icon" style="background: #f4c2c2;"></span> Artificial Gravity</button>
        <button data-area="Docking" aria-selected="false"> <span class="btn-icon" style="background: #c9f5e1;"></span> Docking</button>
      </div>

      <div class="controls-row">
        <button id="fixBtn" class="diagnostics-fix-btn" style="display:none;">Attempt Fix</button>
        <button id="downloadBtn" class="secondary-btn" style="display:none;">Download Report</button>
        <button id="toggleVerbose" class="secondary-btn" aria-pressed="false">Verbose logs</button>
      </div>

      <div class="history" id="historySection" aria-live="polite">
        <h4 style="margin:0.65rem 0 0.35rem 0; color:var(--accent); font-size:0.9rem;">Recent Diagnostics</h4>
        <div id="historyList" style="display:block;"></div>
        <div id="historyControls" style="margin-top:0.5rem;"></div>
      </div>
    </section>

    <section class="details panel" aria-labelledby="detailsHeading">
      <!-- Error count box -->
      <div id="errorCountBox" style="display:none; background:rgba(246,201,77,0.08); border:1px solid rgba(246,201,77,0.18); border-radius:8px; padding:0.7rem; margin-bottom:0.8rem;">
        <div style="display:flex; align-items:center; gap:0.6rem;">
          <div style="width:10px; height:10px; border-radius:50%; background:var(--warning); box-shadow:0 0 8px rgba(246,201,77,0.3);"></div>
          <div style="color:var(--warning); font-weight:600; font-size:0.95rem;">
            <span id="errorCountText">0 issues detected</span>
          </div>
        </div>
      </div>

      <div class="header-row">
        <div>
          <div class="diagnostics-area" id="diagnosticsArea">Select a subsystem to diagnose.</div>
          <div class="diagnostics-error" id="diagnosticsError" aria-live="polite"></div>
        </div>

        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:0.6rem;">
          <div class="status-row">
            <div class="status-led" id="statusLed" title="status LED" aria-hidden="true"></div>
            <div class="status-label" id="statusLabel">Idle</div>
          </div>

          <canvas id="telemetryCanvas" width="200" height="50" aria-hidden="true"></canvas>
        </div>
      </div>

      <div class="diagnostics-status" id="diagnosticsStatus" aria-live="polite"></div>

      <!-- New recommended actions section -->
      <div class="recommendations" id="recommendationsSection" style="display:none;" aria-live="polite">
        <h3>Recommended Actions</h3>
        <ul class="recommendation-list" id="recommendationList"></ul>
      </div>

      <div id="logsWrapper" style="display:none;">
        <h4 style="margin:0.6rem 0 0.35rem 0; color:var(--accent); font-size:0.9rem;">Verbose Log</h4>
        <div class="log" id="verboseLog" aria-live="polite"></div>
      </div>

      <!-- bottom duplicate return link removed per request -->
    </section>
  </main>

  <!-- Success burst overlay element will be created dynamically by JS (replaces confetti) -->

  <script>
    // Original errors & recommendations extended with new systems
    const errors = {
      "Life Support": [
        "O2 sensor readings inconsistent.",
        "Pressure anomaly detected in habitat module.",
        "CO2 scrubber cycling irregularly.",
        "Life support nominal (no issues detected)."
      ],
      "Power": [
        "Power relay fluctuating.",
        "Battery charge below expected threshold.",
        "Auxiliary generator offline.",
        "Power system nominal (no issues detected)."
      ],
      "Shields": [
        "Shield integrity at 92%.",
        "Minor field distortion detected.",
        "Shield generator cooling required.",
        "Shields nominal (no issues detected)."
      ],
      "Navigation": [
        "Gyro calibration drift.",
        "Star tracker intermittent.",
        "Navigation computer lag detected.",
        "Navigation nominal (no issues detected)."
      ],
      "Communications": [
        "Signal attenuation detected.",
        "Antenna alignment off by 0.3°.",
        "Message queue backlog.",
        "Communications nominal (no issues detected)."
      ],

      // New systems
      "Defense Systems": [
        "Interceptor drone bay offline.",
        "Countermeasure dispenser malfunctioning.",
        "Target prioritization anomaly detected.",
        "Defense systems nominal (no issues detected)."
      ],
      "Weapons": [
        "Primary weapon capacitor charging fault.",
        "Turret servo misalignment on port side.",
        "Ammo handling chute jammed.",
        "Weapons nominal (no issues detected)."
      ],
      "Point Defense": [
        "Point-defense turret jammed.",
        "Auto-tracking unstable on micrometeoric impacts.",
        "Short-range targeting sensor fault.",
        "Point Defense nominal (no issues detected)."
      ],
      "ECM": [
        "ECM suite experiencing high SWR on antenna feed.",
        "Jamming signature detected from unknown source.",
        "ECM processing queue overflow.",
        "ECM nominal (no issues detected)."
      ],
      "Sensors": [
        "Long-range radar returns noisy.",
        "LIDAR calibration skew detected.",
        "Passive sensor fusion mismatch.",
        "Sensors nominal (no issues detected)."
      ],
      "Thermal Control": [
        "Heat exchanger fouling detected.",
        "Coolant pump RPM outside expected range.",
        "Local hot-spot detected in engineering bay.",
        "Thermal Control nominal (no issues detected)."
      ],
      "Hull Integrity": [
        "Micrometeorite puncture detected at sector 4A.",
        "Composite layer delamination trend.",
        "Armor plating microfractures detected.",
        "Hull Integrity nominal (no issues detected)."
      ],
      "Gravity": [
        "Gravity field variance detected in deck C.",
        "Artificial gravity emitters out of phase.",
        "Local micro-gravity pocket reported.",
        "Artificial Gravity nominal (no issues detected)."
      ],
      "Docking": [
        "Dock clamp sensors reporting misalignment.",
        "Airlock pressure equalization slow.",
        "Docking computer timeout on handshake.",
        "Docking nominal (no issues detected)."
      ]
    };

    // Mapping from error messages to recommended actions (extended)
    const recommendations = {
      // Life Support
      "O2 sensor readings inconsistent.": [
        "Run O2 sensor calibration routine.",
        "Inspect sensor connectors and cabling for damage.",
        "If calibration fails, replace the O2 sensor and re-test.",
        "Verify atmospheric readings after maintenance."
      ],
      "Pressure anomaly detected in habitat module.": [
        "Isolate the affected habitat module if possible.",
        "Verify pressure sensor outputs and cross-check with redundant sensors.",
        "Inspect seals, valves, and pressure relief systems.",
        "If pressure drops, enact emergency protocols and notify crew."
      ],
      "CO2 scrubber cycling irregularly.": [
        "Check scrubber filter status and replace if saturated.",
        "Verify scrubber power supply and control signals.",
        "Run scrubber self-test and monitor for normal cycling.",
        "Schedule maintenance if irregularities persist."
      ],
      "Life support nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Power
      "Power relay fluctuating.": [
        "Inspect relay connections and mounting.",
        "Cycle the relay through a controlled test.",
        "Replace the relay if instability continues.",
        "Check upstream control signals and load conditions."
      ],
      "Battery charge below expected threshold.": [
        "Run a battery health diagnostic.",
        "Switch non-critical loads to auxiliary or reduce demand.",
        "Attempt a controlled recharge cycle and monitor temperature.",
        "Plan replacement if capacity has degraded beyond safe margins."
      ],
      "Auxiliary generator offline.": [
        "Attempt a remote restart of the generator.",
        "Check fuel/auxiliary resource levels and ignition systems.",
        "If remote restart fails, dispatch maintenance or switch load to primary."
      ],
      "Power system nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Shields
      "Shield integrity at 92%.": [
        "Monitor integrity trend for further decline.",
        "Redistribute power to shield emitters if allowed.",
        "Inspect for recent impacts or external stress to the hull.",
        "Schedule a full shield diagnostic sweep."
      ],
      "Minor field distortion detected.": [
        "Run field calibration routine.",
        "Inspect emitter arrays and field coupling hardware.",
        "Reduce non-essential external loads until field stabilizes."
      ],
      "Shield generator cooling required.": [
        "Increase coolant flow or check coolant pump status.",
        "Inspect cooling lines and heat exchangers for blockages.",
        "Reduce shield output temporarily until cooling is restored."
      ],
      "Shields nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Navigation
      "Gyro calibration drift.": [
        "Run gyro recalibration and alignment routine.",
        "Verify gyro mounting and shock isolation.",
        "Replace gyro module if drift persists after recalibration."
      ],
      "Star tracker intermittent.": [
        "Check star tracker optics for contamination; clean if required.",
        "Verify tracker power and data connections.",
        "Restart tracker electronics/software and monitor performance."
      ],
      "Navigation computer lag detected.": [
        "Restart the navigation computer subsystem in a controlled manner.",
        "Check CPU load, active processes, and available memory.",
        "Update firmware/software if a known issue is present."
      ],
      "Navigation nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Communications
      "Signal attenuation detected.": [
        "Verify line-of-sight and check for obstructions.",
        "Check transmitter power and antenna feed lines for damage.",
        "Run signal amplification/booster diagnostics and adjust gain."
      ],
      "Antenna alignment off by 0.3°.": [
        "Run automatic fine-alignment procedure for the antenna.",
        "If auto-align fails, perform manual alignment using telemetry.",
        "Inspect antenna motors and encoders for wear."
      ],
      "Message queue backlog.": [
        "Prioritize and clear non-critical messages.",
        "Check routing rules and available bandwidth allocation.",
        "If backlog persists, increase processing resources or throttle low-priority traffic."
      ],
      "Communications nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Defense Systems
      "Interceptor drone bay offline.": [
        "Check drone bay power feed and interlocks.",
        "Attempt remote reboot of drone bay controllers.",
        "Verify drone launch rails are unobstructed.",
        "If hardware failure suspected, schedule engineering inspection."
      ],
      "Countermeasure dispenser malfunctioning.": [
        "Run dispenser cycle test and clear any jams.",
        "Check dispenser cartridge levels and replace if empty.",
        "Verify firing control signals and safety interlocks."
      ],
      "Target prioritization anomaly detected.": [
        "Reset target prioritization table and reinitialize the targeting service.",
        "Check sensor fusion inputs for corrupted data.",
        "Escalate to weapons officer if behavior continues."
      ],
      "Defense systems nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Weapons
      "Primary weapon capacitor charging fault.": [
        "Check capacitor bank voltages and charge controller logs.",
        "Isolate the affected bank and attempt a controlled recharge.",
        "Schedule replacement of degraded capacitor modules."
      ],
      "Turret servo misalignment on port side.": [
        "Run turret alignment routine and recalibrate servos.",
        "Inspect servo linkages for mechanical wear or damage.",
        "If alignment cannot be corrected, lock turret and notify maintenance."
      ],
      "Ammo handling chute jammed.": [
        "Cease firing operations and power down feed system.",
        "Attempt manual clearing procedure following safety protocols.",
        "Inspect for foreign objects or deformities in the chute."
      ],
      "Weapons nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Point Defense
      "Point-defense turret jammed.": [
        "Run turret unjam routine and monitor thermal load.",
        "Check turret motor currents and replace worn bearings.",
        "If persistent, bring the turret offline until repaired."
      ],
      "Auto-tracking unstable on micrometeoric impacts.": [
        "Adjust tracking filters to compensate for high-noise environment.",
        "Enable secondary filters and increase sample rate temporarily."
      ],
      "Short-range targeting sensor fault.": [
        "Reinitialize short-range sensor modules and test returns.",
        "Cross-check with nearby sensor arrays for confirmation."
      ],
      "Point Defense nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // ECM
      "ECM suite experiencing high SWR on antenna feed.": [
        "Inspect antenna feed lines for damage and standing wave reflections.",
        "Reduce transmitter power and attempt tune.",
        "Schedule antenna maintenance if SWR remains high."
      ],
      "Jamming signature detected from unknown source.": [
        "Log jamming frequencies and attempt triangulation.",
        "Raise alert level and coordinate with navigation for evasive maneuvers.",
        "Attempt active counter-jamming if authorized."
      ],
      "ECM processing queue overflow.": [
        "Restart ECM processors in a controlled fashion.",
        "Increase processing priority or offload tasks to backup systems."
      ],
      "ECM nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Sensors
      "Long-range radar returns noisy.": [
        "Run radar self-test and inspect antenna surface.",
        "Increase gain and run adaptive noise filtering.",
        "Cross-check returns with passive sensors for validation."
      ],
      "LIDAR calibration skew detected.": [
        "Run LIDAR calibration routine and confirm range gates.",
        "Inspect LIDAR optics for contamination and clean if required."
      ],
      "Passive sensor fusion mismatch.": [
        "Reconcile sensor timestamps and resync clocks.",
        "Restart the sensor fusion service and review sensor confidences."
      ],
      "Sensors nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Thermal Control
      "Heat exchanger fouling detected.": [
        "Increase blowdown temporarily and schedule cleaning of heat exchangers.",
        "Check inlet/outlet temperature deltas and log for trends."
      ],
      "Coolant pump RPM outside expected range.": [
        "Run pump calibration and check drive electronics.",
        "If pump fails calibration, switch to redundant pump and mark for replacement."
      ],
      "Local hot-spot detected in engineering bay.": [
        "Isolate the affected zone and increase local cooling.",
        "Inspect for blocked vents or coolant line restrictions."
      ],
      "Thermal Control nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Hull Integrity
      "Micrometeorite puncture detected at sector 4A.": [
        "Log location and monitor pressure differential.",
        "Apply emergency patch if available and announce to crew.",
        "Schedule EVA or remote repair depending on severity."
      ],
      "Composite layer delamination trend.": [
        "Reduce stress loads in affected area and plan inspection.",
        "Schedule detailed structural analysis."
      ],
      "Armor plating microfractures detected.": [
        "Localize and reinforce plating; avoid high-load maneuvers.",
        "Plan replacement during next maintenance window."
      ],
      "Hull Integrity nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Gravity
      "Gravity field variance detected in deck C.": [
        "Run gravity emitter recalibration routine for deck C.",
        "Check emitter phasing and synchronization signals.",
        "If variance persists, restrict heavy operations in the affected area."
      ],
      "Artificial gravity emitters out of phase.": [
        "Resync emitter clocks and monitor phase error correction.",
        "Schedule emitter maintenance if resync fails."
      ],
      "Local micro-gravity pocket reported.": [
        "Mark affected region and caution crew.",
        "Investigate for local field perturbations or hardware faults."
      ],
      "Artificial Gravity nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Docking
      "Dock clamp sensors reporting misalignment.": [
        "Run auto-alignment routine and reattempt clamp.",
        "If auto-align fails, conduct manual alignment with visual telemetry."
      ],
      "Airlock pressure equalization slow.": [
        "Check valves and vent control actuators for response.",
        "Run pressure equalization diagnostic and inspect filter elements."
      ],
      "Docking computer timeout on handshake.": [
        "Restart docking services and check network health between ships.",
        "Confirm compatible handshake versions with connecting vessel."
      ],
      "Docking nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ]
    };

    // UI elements
    const areaButtons = Array.from(document.querySelectorAll('.diagnostics-select button'));
    const diagnosticsArea = document.getElementById('diagnosticsArea');
    const diagnosticsError = document.getElementById('diagnosticsError');
    const diagnosticsStatus = document.getElementById('diagnosticsStatus');
    const fixBtn = document.getElementById('fixBtn');
    const recommendationsSection = document.getElementById('recommendationsSection');
    const recommendationList = document.getElementById('recommendationList');
    const statusLed = document.getElementById('statusLed');
    const statusLabel = document.getElementById('statusLabel');
    const telemetryCanvas = document.getElementById('telemetryCanvas');
    const downloadBtn = document.getElementById('downloadBtn');
    const toggleVerbose = document.getElementById('toggleVerbose');
    const logsWrapper = document.getElementById('logsWrapper');
    const verboseLog = document.getElementById('verboseLog');
    const historyList = document.getElementById('historyList');
    const historyControls = document.getElementById('historyControls');
    const errorCountBox = document.getElementById('errorCountBox');
    const errorCountText = document.getElementById('errorCountText');
    // confetti canvas removed - success burst will be created dynamically

    let selectedArea = null;
    let currentError = null;
    let issueResolved = false;
    let escalationAdded = false;
    const HISTORY_KEY = 'obsidian_diag_history_v1';
    const LAST_SELECTED_KEY = 'obsidian_diag_last_selected';
    
    // Track subsystem states for error counting and tagging
    const subsystemStates = {};

    // New: how many history entries to show by default
    const HISTORY_DISPLAY_LIMIT = 5;
    let showAllHistory = false;

    // Simple beep generator using WebAudio
    function beep(duration = 120, freq = 440, type = 'sine', volume = 0.03) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = type;
        o.frequency.value = freq;
        g.gain.value = volume;
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        setTimeout(() => { o.stop(); ctx.close(); }, duration);
      } catch (e) { /* ignore if audio not allowed */ }
    }

    // Telemetry sparkline renderer (simple simulated data)
    function drawTelemetry(seed = 50) {
      const c = telemetryCanvas;
      const ctx = c.getContext('2d');
      const w = c.width, h = c.height;
      ctx.clearRect(0,0,w,h);

      // generate small series
      const pts = [];
      let val = seed + (Math.random()*6 - 3);
      for (let i=0;i<22;i++){
        val += (Math.random()*4 - 2);
        val = Math.max(6, Math.min(94, val));
        pts.push(val);
      }

      // background gradient
      const g = ctx.createLinearGradient(0,0,0,h);
      g.addColorStop(0, 'rgba(79,209,197,0.06)');
      g.addColorStop(1, 'rgba(79,209,197,0.01)');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);

      // sparkline
      ctx.beginPath();
      for (let i=0;i<pts.length;i++){
        const x = (i/(pts.length-1)) * (w-6) + 3;
        const y = h - (pts[i]/100 * (h-10)) - 5;
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.strokeStyle = 'rgba(79,209,197,0.98)';
      ctx.lineWidth = 2;
      ctx.stroke();

      // last dot
      const lastX = ( (pts.length-1)/(pts.length-1) ) * (w-6) + 3;
      const lastY = h - (pts[pts.length-1]/100 * (h-10)) - 5;
      ctx.fillStyle = 'rgba(79,209,197,0.98)';
      ctx.beginPath();
      ctx.arc(lastX,lastY,3,0,Math.PI*2);
      ctx.fill();
    }

    // Replace confetti with a subtle themed success burst.
    // This function keeps the old name (triggerConfetti) so existing calls don't need to be changed.
    function triggerConfetti() {
      try {
        // remove any existing burst
        const existing = document.querySelector('.success-burst');
        if (existing) {
          existing.classList.remove('show');
          existing.remove();
        }

        const container = document.createElement('div');
        container.className = 'success-burst';
        container.setAttribute('aria-hidden', 'true');

        // dots layer
        const dots = document.createElement('div');
        dots.className = 'dots';

        // colors matching theme
        const colors = ['#6ee7d7','#4fd1c5','#ffd166','#bdb2ff','#9be7c6'];

        // create several dots around center with random directions
        const count = 10;
        for (let i = 0; i < count; i++) {
          const d = document.createElement('div');
          d.className = 'dot';
          d.style.background = colors[i % colors.length];
          const angle = (i / count) * Math.PI * 2 + (Math.random() - 0.5) * 0.6;
          const dist = 36 + Math.random() * 56;
          const dx = Math.cos(angle) * dist + 'px';
          const dy = Math.sin(angle) * (dist * 0.6) + 'px';
          d.style.setProperty('--dx', dx);
          d.style.setProperty('--dy', dy);
          // offset each slightly so animation looks organic
          d.style.left = '50%';
          d.style.top = '50%';
          d.style.transform = 'translate(-50%,-50%)';
          d.style.animation = `burst 700ms cubic-bezier(.2,.9,.2,1) ${Math.random()*110}ms forwards`;
          d.style.opacity = '0';
          dots.appendChild(d);
        }

        // check area with ring + SVG checkmark
        const checkWrap = document.createElement('div');
        checkWrap.className = 'check';
        const ring = document.createElement('div');
        ring.className = 'ring';

        // SVG checkmark
        const svgns = 'http://www.w3.org/2000/svg';
        const svg = document.createElementNS(svgns, 'svg');
        svg.setAttribute('class', 'checkmark');
        svg.setAttribute('viewBox', '0 0 24 24');
        const path = document.createElementNS(svgns, 'path');
        path.setAttribute('d', 'M4.5 12.5l4 4 11-11');
        svg.appendChild(path);

        checkWrap.appendChild(svg);
        container.appendChild(dots);
        container.appendChild(ring);
        container.appendChild(checkWrap);

        document.body.appendChild(container);

        // trigger show state to run transitions
        requestAnimationFrame(() => {
          setTimeout(() => container.classList.add('show'), 12);
        });

        // remove after animation
        setTimeout(() => {
          container.classList.remove('show');
          setTimeout(() => { if (container.parentNode) container.parentNode.removeChild(container); }, 260);
        }, 1600);

        // light success beep (very subtle)
        try { beep(110, 740, 'sine', 0.02); } catch(e) {}
      } catch (e) {
        // fail silently if something goes wrong
      }
    }

    // History management
    function pushHistory(entry) {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        arr.unshift(entry);
        while (arr.length > 10) arr.pop();
        localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
        renderHistory();
      } catch (e) { /* ignore */ }
    }

    function renderHistory() {
      const raw = localStorage.getItem(HISTORY_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      historyList.innerHTML = '';
      historyControls.innerHTML = '';

      if (!arr.length) {
        historyList.innerHTML = '<div style="color:var(--text-muted); font-size:0.9rem;">No previous diagnostics</div>';
        return;
      }

      // Choose slice according to showAllHistory and the display limit
      const toShow = showAllHistory ? arr : arr.slice(0, HISTORY_DISPLAY_LIMIT);

      toShow.forEach((h, idx) => {
        const el = document.createElement('div');
        el.className = 'history-item';
        el.tabIndex = 0;
        el.innerHTML = `<strong>${h.area}</strong> — <span style="color:var(--text-muted)">${new Date(h.time).toLocaleString()}</span><div style="font-size:0.86rem; color:var(--text-muted); margin-top:4px;">${h.error || ''}</div>`;
        el.addEventListener('click', () => {
          restoreHistoryItem(h);
        });
        el.addEventListener('keypress', (e) => { if (e.key === 'Enter') restoreHistoryItem(h); });
        historyList.appendChild(el);
      });

      // If there are more entries than the display limit, show a toggle control
      if (arr.length > HISTORY_DISPLAY_LIMIT) {
        const btn = document.createElement('button');
        btn.className = 'secondary-btn';
        btn.style.padding = '0.35rem 0.55rem';
        btn.textContent = showAllHistory ? 'Show less' : `Show ${Math.min(arr.length, HISTORY_DISPLAY_LIMIT)} of ${arr.length}`;
        btn.addEventListener('click', () => {
          showAllHistory = !showAllHistory;
          renderHistory();
        });
        historyControls.appendChild(btn);
      }
    }

    function restoreHistoryItem(h) {
      // find and "click" the area button
      const btn = areaButtons.find(b => b.getAttribute('data-area') === h.area);
      if (btn) btn.click();
      // populate error and recommendations explicitly (preserve timestamp)
      currentError = h.error;
      diagnosticsError.textContent = currentError;
      diagnosticsStatus.textContent = h.statusText || '';
      showRecommendationsFor(currentError);
      // log
      appendLog(`Restored historical diagnostic from ${new Date(h.time).toLocaleString()}`);
    }

    // Logging helper
    function appendLog(msg) {
      const t = new Date().toLocaleTimeString();
      verboseLog.innerHTML = `<div>[${t}] ${msg}</div>` + verboseLog.innerHTML;
    }

    // Draw LED based on error text severity and set diagnosticsStatus color accordingly
    function setLedForError(text) {
      const root = getComputedStyle(document.documentElement);
      const danger = root.getPropertyValue('--danger').trim() || '#ff6b6b';
      const success = root.getPropertyValue('--success').trim() || '#4ade80';
      const warning = root.getPropertyValue('--warning').trim() || '#f6c94d';
      const muted = root.getPropertyValue('--text-muted').trim() || '#9aa6b4';

      if (!text) {
        statusLed.style.background = '#2b2f34';
        statusLed.style.boxShadow = '';
        statusLabel.textContent = 'Idle';
        diagnosticsStatus.style.color = muted;
        return;
      }
      if (text.includes('nominal')) {
        statusLed.style.background = 'linear-gradient(180deg, var(--success), #2f9c61)';
        statusLed.style.boxShadow = '0 0 8px rgba(74,222,128,0.18)';
        statusLabel.textContent = 'Nominal';
        diagnosticsStatus.style.color = success;
      } else if (text.match(/(minor|backlog|intermittent|fluctuating|drift|attenuation|noisy|skew|micro)/i)) {
        statusLed.style.background = 'linear-gradient(180deg, var(--warning), #d9b600)';
        statusLed.style.boxShadow = '0 0 8px rgba(246,201,77,0.15)';
        statusLabel.textContent = 'Degraded';
        diagnosticsStatus.style.color = warning;
      } else {
        statusLed.style.background = 'linear-gradient(180deg, var(--danger), #d04848)';
        statusLed.style.boxShadow = '0 0 10px rgba(255,107,107,0.12)';
        statusLabel.textContent = 'Issue';
        diagnosticsStatus.style.color = danger;
      }
    }

    // Prevent duplicate escalation recommendations being appended repeatedly
    escalationAdded = false;

    // Update error count display and button tags
    function updateErrorCountAndTags() {
      let errorCount = 0;
      const areasWithErrors = [];
      
      // Count subsystems with errors (non-nominal states)
      for (const area in subsystemStates) {
        if (subsystemStates[area] && !subsystemStates[area].includes('nominal')) {
          errorCount++;
          areasWithErrors.push(area);
        }
      }
      
      // Update error count box
      if (errorCount > 0) {
        errorCountBox.style.display = 'block';
        errorCountText.textContent = errorCount === 1 ? '1 issue detected' : `${errorCount} issues detected`;
      } else {
        errorCountBox.style.display = 'none';
      }
      
      // Update button tags
      areaButtons.forEach(btn => {
        const area = btn.getAttribute('data-area');
        const state = subsystemStates[area];
        
        // Remove existing tag if present
        const existingTag = btn.querySelector('.error-tag');
        if (existingTag) existingTag.remove();
        
        // Add tag if subsystem has an error
        if (state && !state.includes('nominal')) {
          const tag = document.createElement('span');
          tag.className = 'error-tag';
          tag.style.cssText = 'background:var(--warning); color:var(--bg-dark); padding:2px 6px; border-radius:4px; font-size:0.75rem; font-weight:700; margin-left:auto;';
          tag.textContent = 'REVIEW';
          btn.appendChild(tag);
        }
      });
    }

    function showRecommendationsFor(errorText) {
      if (!errorText) {
        recommendationsSection.style.display = 'none';
        return;
      }
      const recs = recommendations[errorText] || null;

      if (recs && recs.length > 0) {
        recommendationList.innerHTML = recs.map(r => `<li>${r}</li>`).join('');
        recommendationsSection.style.display = 'block';
        escalationAdded = false;
      } else {
        recommendationList.innerHTML = `<li>No specific recommended actions available. Run full diagnostics.</li>`;
        recommendationsSection.style.display = 'block';
        escalationAdded = false;
      }
    }

    // Populate area button behaviors
    areaButtons.forEach((btn, idx) => {
      btn.addEventListener('click', () => {
        // update selection visuals and aria
        areaButtons.forEach(b => { b.classList.remove('selected'); b.setAttribute('aria-selected','false'); });
        btn.classList.add('selected');
        btn.setAttribute('aria-selected','true');

        selectedArea = btn.getAttribute('data-area');
        diagnosticsArea.textContent = `Diagnosing: ${selectedArea}`;

        // select random error
        const list = errors[selectedArea] || [];
        const err = list[Math.floor(Math.random() * list.length)];
        currentError = err;
        diagnosticsError.textContent = currentError || '';

        // update LED & status text and color
        setLedForError(currentError);
        if (currentError && currentError.includes('nominal')) {
          diagnosticsStatus.textContent = 'All systems within expected parameters.';
          diagnosticsError.classList.remove('diagnostics-nominal');
          diagnosticsError.classList.add('diagnostics-nominal');
          subsystemStates[selectedArea] = currentError;
        } else {
          diagnosticsStatus.textContent = 'Anomaly detected — recommended actions available.';
          diagnosticsStatus.style.color = 'var(--warning)'; // Ensure yellow color for anomaly message
          diagnosticsError.classList.remove('diagnostics-nominal');
          subsystemStates[selectedArea] = currentError;
        }
        
        // Update error count and tags after state change
        updateErrorCountAndTags();

        // show/hide controls
        if (currentError && !currentError.includes('nominal')) {
          fixBtn.style.display = 'inline-flex';
          downloadBtn.style.display = 'inline-flex';
        } else {
          fixBtn.style.display = 'none';
          downloadBtn.style.display = 'none';
        }

        // show recommendations
        showRecommendationsFor(currentError);

        // draw telemetry seeded by severity
        const seed = currentError && currentError.includes('nominal') ? 60 : 42 + (Math.random()*18);
        drawTelemetry(seed);

        // log & history
        appendLog(`Diagnosed ${selectedArea}: ${currentError}`);
        pushHistory({ area: selectedArea, error: currentError, time: Date.now(), statusText: diagnosticsStatus.textContent });

        // store last selected
        try { localStorage.setItem(LAST_SELECTED_KEY, selectedArea); } catch(e) {}
      });
    });

    // Fix button behavior (attempt)
    fixBtn.addEventListener('click', () => {
      if (!selectedArea || !currentError) return;
      appendLog(`Attempting fix for ${selectedArea} — ${currentError}`);
      // simulate fix success for non-nominal issues
      const success = Math.random() > 0.35;
      const root = getComputedStyle(document.documentElement);
      const danger = root.getPropertyValue('--danger').trim() || '#ff6b6b';
      const successColor = root.getPropertyValue('--success').trim() || '#4ade80';

      if (success) {
        diagnosticsError.textContent = `${selectedArea} — issue resolved.`;
        diagnosticsError.classList.add('diagnostics-nominal');
        diagnosticsStatus.textContent = 'Resolved';
        // update LED + status color to nominal
        setLedForError('nominal');
        diagnosticsStatus.style.color = successColor;
        subsystemStates[selectedArea] = 'nominal'; // Mark as resolved
        updateErrorCountAndTags(); // Update counts and tags
        pushHistory({ area: selectedArea, error: `${selectedArea} — issue resolved.`, time: Date.now(), statusText: 'Resolved' });
        // celebration (replaced confetti)
        triggerConfetti();
        issueResolved = true;
      } else {
        diagnosticsStatus.textContent = 'Fix attempt failed. Escalating recommended.';
        // explicitly ensure status color is danger (red)
        diagnosticsStatus.style.color = danger;
        appendLog('Fix attempt failed; escalation recommended.');
        // append escalation recommendation once
        if (!escalationAdded) {
          const li = document.createElement('li');
          li.textContent = 'Escalate to engineering — on-call required for hardware intervention.';
          recommendationList.appendChild(li);
          escalationAdded = true;
        }
      }
    });

    // Download report (simple TXT)
    downloadBtn.addEventListener('click', () => {
      const report = `Diagnostics Report\nArea: ${selectedArea}\nStatus: ${diagnosticsStatus.textContent}\nError: ${currentError}\nTime: ${new Date().toISOString()}\n`;
      const blob = new Blob([report], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `diagnostics_${selectedArea.replace(/\s+/g,'_')}_${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      appendLog('Downloaded diagnostics report.');
    });

    // Verbose toggle
    toggleVerbose.addEventListener('click', () => {
      const pressed = toggleVerbose.getAttribute('aria-pressed') === 'true';
      toggleVerbose.setAttribute('aria-pressed', String(!pressed));
      logsWrapper.style.display = pressed ? 'none' : 'block';
    });

    // Initialize: scan all subsystems to populate initial states
    function initializeSubsystems() {
      areaButtons.forEach(btn => {
        const area = btn.getAttribute('data-area');
        const list = errors[area] || [];
        const err = list[Math.floor(Math.random() * list.length)];
        subsystemStates[area] = err;
      });
      updateErrorCountAndTags();
    }

    // Initialization: restore last selected
    try {
      const last = localStorage.getItem(LAST_SELECTED_KEY);
      initializeSubsystems(); // Initialize all subsystems first
      if (last) {
        const btn = areaButtons.find(b => b.getAttribute('data-area') === last);
        if (btn) btn.click();
      }
    } catch (e) { /* ignore */ }

    // initial render history
    renderHistory();
  </script>
</body>
</html>
