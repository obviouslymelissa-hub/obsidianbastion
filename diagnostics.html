<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Diagnostics — Obsidian Bastion</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="app.css">
  <style>
    :root {
      --bg-dark: #181c24;
      --bg-panel: #23283a;
      --accent: #4fd1c5;
      --text-main: #e2e8f0;
      --text-muted: #a0aec0;
      --border: #2d3748;
      --danger: #e53e3e;
      --success: #38a169;
      --warning: #ecc94b;
      --font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
    }
    body {
      color: var(--text-main);
      font-family: var(--font-family);
      margin: 0;
      padding: 0;
    }
    main {
      max-width: 600px;
      margin: 2rem auto;
      background: var(--bg-panel);
      border-radius: 12px;
      box-shadow: 0 2px 8px #0003;
      padding: 2rem;
      border: 1px solid var(--border);
    }
    .diagnostics-select {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    .diagnostics-select button {
      background: var(--accent);
      color: var(--bg-dark);
      border: none;
      border-radius: 6px;
      padding: 0.7rem 1.2rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .diagnostics-select button.selected,
    .diagnostics-select button:hover {
      background: #38b2ac;
    }
    .diagnostics-area {
      margin-bottom: 1.5rem;
      font-size: 1.1rem;
      color: var(--accent);
      text-align: center;
    }
    .diagnostics-error {
      background: #1a202c;
      color: var(--danger);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      text-align: center;
      font-size: 1.05rem;
      border: 1px solid var(--danger);
      min-height: 2.5em;
      transition: background 0.2s;
    }
    .diagnostics-status {
      text-align: center;
      font-size: 1.05rem;
      margin-bottom: 1rem;
      color: var(--success);
      min-height: 2em;
    }
    .diagnostics-fix-btn {
      display: block;
      margin: 1rem auto 0 auto;
      background: var(--success);
      color: var(--bg-dark);
      border: none;
      border-radius: 6px;
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .diagnostics-fix-btn:hover {
      background: #2f855a;
    }
    .recommendations {
      margin-top: 1.25rem;
      background: #0f1724;
      border: 1px solid rgba(79,209,197,0.12);
      padding: 1rem;
      border-radius: 8px;
      color: var(--text-main);
    }
    .recommendations h3 {
      margin: 0 0 0.5rem 0;
      color: var(--accent);
      font-size: 1.05rem;
      text-align: center;
    }
    .recommendation-list {
      margin: 0;
      padding-left: 1.2rem;
      color: var(--text-muted);
      font-size: 0.98rem;
    }
    .recommendation-list li {
      margin-bottom: 0.4rem;
    }
    .return-link {
      display: block;
      text-align: center;
      margin-top: 2rem;
      color: var(--accent);
      text-decoration: none;
      font-size: 1rem;
    }
    .return-link:hover {
      text-decoration: underline;
    }
    /* small screens */
    @media (max-width: 480px) {
      .diagnostics-select button { padding: 0.5rem 0.8rem; font-size: .95rem; }
      main { padding: 1rem; margin: 1rem; }
    }
  </style>
</head>
<body>
  <!-- Shared site header -->
  <header class="site-header">
    <div class="header-inner" role="banner" aria-label="Obsidian Bastion header">
      <div class="header-left">
        <div class="site-emblem" aria-hidden="true" title="Obsidian Bastion emblem">
          <img src="https://obviouslymelissa-hub.github.io/obsidianbastion/images/StrOpBoard.png" alt="Strategic Operations Board">
        </div>
        <div class="header-text" aria-label="Site title">
          <h1>Obsidian Bastion</h1>
          <h2>Diagnostics</h2>
        </div>
      </div>
      <div class="header-right">
        <a href="https://obviouslymelissa-hub.github.io/obsidianbastion/index.html" class="return-command-hub" aria-label="Return to Command Hub">← Return to Command Hub</a>
      </div>
    </div>
  </header>

  <main>
    <div class="diagnostics-select" role="tablist" aria-label="Subsystems">
      <button data-area="Life Support">Life Support</button>
      <button data-area="Power">Power</button>
      <button data-area="Shields">Shields</button>
      <button data-area="Navigation">Navigation</button>
      <button data-area="Communications">Communications</button>
    </div>

    <div class="diagnostics-area" id="diagnosticsArea">Select a subsystem to diagnose.</div>
    <div class="diagnostics-error" id="diagnosticsError" aria-live="polite"></div>
    <div class="diagnostics-status" id="diagnosticsStatus" aria-live="polite"></div>

    <!-- New recommended actions section -->
    <div class="recommendations" id="recommendationsSection" style="display:none;" aria-live="polite">
      <h3>Recommended Actions</h3>
      <ul class="recommendation-list" id="recommendationList"></ul>
    </div>

    <button class="diagnostics-fix-btn" id="fixBtn" style="display:none;">Attempt Fix</button>
    <a href="https://obviouslymelissa-hub.github.io/obsidianbastion/index.html" class="return-link">← Back to Command Hub</a>
  </main>
  <script>
    // Vague error messages for each subsystem
    const errors = {
      "Life Support": [
        "O2 sensor readings inconsistent.",
        "Pressure anomaly detected in habitat module.",
        "CO2 scrubber cycling irregularly.",
        "Life support nominal (no issues detected)."
      ],
      "Power": [
        "Power relay fluctuating.",
        "Battery charge below expected threshold.",
        "Auxiliary generator offline.",
        "Power system nominal (no issues detected)."
      ],
      "Shields": [
        "Shield integrity at 92%.",
        "Minor field distortion detected.",
        "Shield generator cooling required.",
        "Shields nominal (no issues detected)."
      ],
      "Navigation": [
        "Gyro calibration drift.",
        "Star tracker intermittent.",
        "Navigation computer lag detected.",
        "Navigation nominal (no issues detected)."
      ],
      "Communications": [
        "Signal attenuation detected.",
        "Antenna alignment off by 0.3°.",
        "Message queue backlog.",
        "Communications nominal (no issues detected)."
      ]
    };

    // Mapping from specific error messages to recommended actions
    const recommendations = {
      // Life Support
      "O2 sensor readings inconsistent.": [
        "Run O2 sensor calibration routine.",
        "Inspect sensor connectors and cabling for damage.",
        "If calibration fails, replace the O2 sensor and re-test.",
        "Verify atmospheric readings after maintenance."
      ],
      "Pressure anomaly detected in habitat module.": [
        "Isolate the affected habitat module if possible.",
        "Verify pressure sensor outputs and cross-check with redundant sensors.",
        "Inspect seals, valves, and pressure relief systems.",
        "If pressure drops, enact emergency protocols and notify crew."
      ],
      "CO2 scrubber cycling irregularly.": [
        "Check scrubber filter status and replace if saturated.",
        "Verify scrubber power supply and control signals.",
        "Run scrubber self-test and monitor for normal cycling.",
        "Schedule maintenance if irregularities persist."
      ],
      "Life support nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Power
      "Power relay fluctuating.": [
        "Inspect relay connections and mounting.",
        "Cycle the relay through a controlled test.",
        "Replace the relay if instability continues.",
        "Check upstream control signals and load conditions."
      ],
      "Battery charge below expected threshold.": [
        "Run a battery health diagnostic.",
        "Switch non-critical loads to auxiliary or reduce demand.",
        "Attempt a controlled recharge cycle and monitor temperature.",
        "Plan replacement if capacity has degraded beyond safe margins."
      ],
      "Auxiliary generator offline.": [
        "Attempt a remote restart of the generator.",
        "Check fuel/auxiliary resource levels and ignition systems.",
        "If remote restart fails, dispatch maintenance or switch load to primary."
      ],
      "Power system nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Shields
      "Shield integrity at 92%.": [
        "Monitor integrity trend for further decline.",
        "Redistribute power to shield emitters if allowed.",
        "Inspect for recent impacts or external stress to the hull.",
        "Schedule a full shield diagnostic sweep."
      ],
      "Minor field distortion detected.": [
        "Run field calibration routine.",
        "Inspect emitter arrays and field coupling hardware.",
        "Reduce non-essential external loads until field stabilizes."
      ],
      "Shield generator cooling required.": [
        "Increase coolant flow or check coolant pump status.",
        "Inspect cooling lines and heat exchangers for blockages.",
        "Reduce shield output temporarily until cooling is restored."
      ],
      "Shields nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Navigation
      "Gyro calibration drift.": [
        "Run gyro recalibration and alignment routine.",
        "Verify gyro mounting and shock isolation.",
        "Replace gyro module if drift persists after recalibration."
      ],
      "Star tracker intermittent.": [
        "Check star tracker optics for contamination; clean if required.",
        "Verify tracker power and data connections.",
        "Restart tracker electronics/software and monitor performance."
      ],
      "Navigation computer lag detected.": [
        "Restart the navigation computer subsystem in a controlled manner.",
        "Check CPU load, active processes, and available memory.",
        "Update firmware/software if a known issue is present."
      ],
      "Navigation nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ],

      // Communications
      "Signal attenuation detected.": [
        "Verify line-of-sight and check for obstructions.",
        "Check transmitter power and antenna feed lines for damage.",
        "Run signal amplification/booster diagnostics and adjust gain."
      ],
      "Antenna alignment off by 0.3°.": [
        "Run automatic fine-alignment procedure for the antenna.",
        "If auto-align fails, perform manual alignment using telemetry.",
        "Inspect antenna motors and encoders for wear."
      ],
      "Message queue backlog.": [
        "Prioritize and clear non-critical messages.",
        "Check routing rules and available bandwidth allocation.",
        "If backlog persists, increase processing resources or throttle low-priority traffic."
      ],
      "Communications nominal (no issues detected).": [
        "No action required — subsystem nominal. Continue routine monitoring."
      ]
    };

    const areaButtons = document.querySelectorAll('.diagnostics-select button');
    const diagnosticsArea = document.getElementById('diagnosticsArea');
    const diagnosticsError = document.getElementById('diagnosticsError');
    const diagnosticsStatus = document.getElementById('diagnosticsStatus');
    const fixBtn = document.getElementById('fixBtn');
    const recommendationsSection = document.getElementById('recommendationsSection');
    const recommendationList = document.getElementById('recommendationList');

    let selectedArea = null;
    let currentError = null;
    let issueResolved = false;

    // Prevent duplicate escalation recommendations being appended repeatedly
    let escalationAdded = false;

    function showRecommendationsFor(errorText) {
      // If no error text, hide section
      if (!errorText) {
        recommendationsSection.style.display = 'none';
        return;
      }

      const recs = recommendations[errorText] || null;

      if (recs && recs.length > 0) {
        recommendationList.innerHTML = recs.map(r => `<li>${r}</li>`).join('');
        recommendationsSection.style.display = 'block';
        // reset escalation flag for a fresh selection
        escalationAdded = false;
      } else {
        recommendationList.innerHTML = `<li>No specific recommended actions available. Run full diagnostics.</li>`;
        recommendationsSection.style.display = 'block';
        escalationAdded = false;
      }
    }

    areaButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        areaButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedArea = btn.getAttribute('data-area');
        diagnosticsArea.textContent = `Diagnosing: ${selectedArea}`;
        // Randomly select an error (sometimes "nominal")
        const errorList = errors[selectedArea];
        const idx = Math.floor(Math.random() * errorList.length);
        currentError = errorList[idx];
        diagnosticsError.textContent = currentError;
        diagnosticsStatus.textContent = '';
        issueResolved = false;

        // reset escalation flag so new error can receive escalation once if needed
        escalationAdded = false;

        // If nominal, hide fix button and show nominal styling/message
        if (currentError.includes('nominal')) {
          fixBtn.style.display = 'none';
          diagnosticsError.style.color = 'var(--accent)';
        } else {
          fixBtn.style.display = 'block';
          diagnosticsError.style.color = 'var(--danger)';
        }

        // Show recommended actions for the selected error
        showRecommendationsFor(currentError);
      });
    });

    fixBtn.addEventListener('click', () => {
      // Randomly resolve or persist the issue
      if (Math.random() < 0.5) {
        diagnosticsStatus.textContent = "Issue persists. Further diagnostics required.";
        diagnosticsStatus.style.color = "var(--danger)";

        // Append escalation recommendations but only once per diagnostic result
        if (!escalationAdded) {
          const escalation = [
            "Document observed behavior and recent logs.",
            "Run extended diagnostics and capture telemetry.",
            "Escalate to engineering if on-site maintenance is required."
          ];
          // append escalation as additional list items
          recommendationList.innerHTML = recommendationList.innerHTML + escalation.map(r => `<li>${r}</li>`).join('');
          escalationAdded = true;
        }
      } else {
        diagnosticsStatus.textContent = "Issue resolved. Subsystem nominal.";
        diagnosticsStatus.style.color = "var(--success)";
        fixBtn.style.display = 'none';
        diagnosticsError.textContent = '';
        // Update recommendations to indicate resolution and monitoring steps
        recommendationList.innerHTML = `<li>Issue appears resolved. Monitor subsystem for recurrence over the next 24 hours.</li>
                                        <li>Log the repair attempt and any actions taken.</li>`;
        // After resolution we still show the recommendations section (monitoring + log)
        recommendationsSection.style.display = 'block';
        // reset escalation flag for future checks
        escalationAdded = false;
      }
    });
  </script>
</body>
</html>
