<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>System Health — Obsidian Bastion</title>

  <!-- Inter is optional; if you prefer a local font, remove the link -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />

  <!-- Chart.js - Choose ONE of the following options based on your environment -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <link rel="stylesheet" href="app.css">
  <style>
    :root{
      --bg-dark: #0f1318;
      --bg-panel: #151821;
      --accent: #4fd1c5;
      --accent-2: #7ef0df;
      --text-main: #e6eef2;
      --text-muted: #9fb2bf;
      --border: #22272f;
      --bg:#071217;
      --muted:#7fb1bf;
      --card: rgba(255,255,255,0.02);
      --card-border: rgba(255,255,255,0.03);
      --accent-blue:#66a0ff;
      --accent-green:#78e08f;
      --danger:#ff7b7b;
      --warn:#ffb86b;
      --glass: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --radius:12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Segoe UI Mono", monospace;
    }

    html,body{height:100%}
    body{
      margin:0;
      min-height:100%;
      font-family:'Segoe UI','Roboto',Arial,sans-serif;
      color:var(--text-main);
      padding:0;
      background:var(--bg-dark);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .page-content {
      padding: 24px;
    }

    /* Site header styles */
    .site-header {
      background:
        radial-gradient(600px 120px at 10% 30%, rgba(127,240,223,0.06), transparent 8%),
        radial-gradient(500px 100px at 90% 60%, rgba(79,209,197,0.04), transparent 6%),
        linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      border-bottom: 2px solid rgba(79,209,197,0.12);
      padding: 12px 18px;
    }
    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 18px;
      justify-content: space-between;
      padding: 8px 6px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 14px;
      min-width: 0;
    }
    .site-emblem {
      width: 60px;
      height: 60px;
      flex: 0 0 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(127,240,223,0.06), rgba(79,209,197,0.02));
      border: 1px solid rgba(127,240,223,0.08);
      box-shadow: 0 6px 20px rgba(0,0,0,0.5), 0 0 30px rgba(79,209,197,0.02) inset;
    }
    .site-emblem img {
      width: 42px;
      height: 42px;
      display: block;
      object-fit: contain;
    }
    .header-text h1 {
      margin: 0;
      font-size: 1.3rem;
      color: var(--text-main);
      letter-spacing: 1.2px;
      font-weight: 800;
    }
    .header-text h2 {
      margin: 4px 0 0 0;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.6px;
    }
    .return-command-hub {
      background: var(--accent);
      color: var(--bg-panel);
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 700;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .return-command-hub:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }

    .page-header{
      display:flex;
      gap:16px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }

    .page-header .title{
      display:flex;
      gap:12px;
      align-items:baseline;
    }
    h1{font-size:20px;margin:0;font-weight:600}
    .muted {color:var(--muted); font-size:13px}

    .controls{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .card{
      background:var(--card);
      border:1px solid var(--card-border);
      padding:14px;
      border-radius:var(--radius);
      box-shadow: 0 4px 20px rgba(2,8,12,0.4);
    }

    .layout{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
      align-items:start;
    }

    /* left column (summary) */
    .left{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .summary .stat{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      padding:10px;
    }

    .stat .label{color:var(--muted);font-size:13px}
    .stat .value{font-weight:600;font-size:18px}

    /* main area */
    .main{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .toolbar{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
    }
    .toolbar .left, .toolbar .right{display:flex;gap:8px;align-items:center}

    button, .seg button{
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:inherit;
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
    }
    button.primary{
      background:var(--accent);
      color:var(--bg-panel);
      border:0;
      font-weight:700;
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    button.primary:hover{
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }

    .seg{display:flex;background:rgba(255,255,255,0.02);border-radius:10px;padding:4px}
    .seg button.active{background:rgba(255,255,255,0.04);}

    .chart-wrap{
      padding:12px;
      background:var(--glass);
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.03);
      min-height:160px; /* reserve space for chart + padding to reduce layout shift */
    }

    footer{margin-top:16px;color:var(--muted);font-size:13px}

    #mainChart { width:100%; height:220px; }
    #contentionChart, #packetChart { width:100%; height:140px; }

    @media (max-width:900px){
      .layout{grid-template-columns: 1fr; }
      .left{order:0; margin-bottom:16px}
      .main{order:1}
    }

    .note{font-size:13px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .badge{font-size:12px;padding:6px;border-radius:8px;background:rgba(0,0,0,0.2)}

    /* incident log styles */
    .incident-log { display:flex; flex-direction:column; gap:10px; }
    /* Make each incident one column tall (timestamp & owner at the top) */
    .incident { 
      display:flex; 
      flex-direction:column;
      gap:10px;
      align-items:stretch; 
      padding:10px; 
      border-radius:10px; 
      background:rgba(255,255,255,0.012); 
      border:1px solid rgba(255,255,255,0.02); 
    }
    .incident .meta { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      font-size:12px; 
      color:var(--muted);
      gap:8px;
      width:100%;
    }
    .incident .meta .time { font-family:var(--mono); color:#bfe7ff; display:block; }
    .incident .meta .owner { text-align:right; color:var(--muted); font-size:12px; }
    .incident .main { flex:1; display:flex; flex-direction:column; gap:8px; }
    .incident .title { font-weight:600; margin:0; font-size:13px; }
    .incident .desc { font-size:13px; color:var(--muted); margin:0; }
    .pill { display:inline-block; padding:6px 8px; border-radius:999px; font-size:12px; font-weight:600; color:#021219; }
    .sev-critical { background:linear-gradient(90deg,var(--danger),#ff9e9e); }
    .sev-high { background:linear-gradient(90deg,var(--warn),#ffd39a); color:#021219; }
    .sev-ok { background:linear-gradient(90deg,var(--accent-2),#aaf7c8); color:#021219; }
    .incident .actions { display:flex; gap:8px; margin-top:6px; }
    .muted-link { color:var(--accent); text-decoration:none; font-size:13px; }
    .small-muted { font-size:12px; color:var(--muted); }
    .resolved { opacity:0.6; text-decoration:line-through; }

    /* Make the toolbar's badge sit at the very left inside the toolbar card */
    .card.toolbar { padding-left: 0; } /* overrides .card default left padding for this toolbar only */

    /* Optional helper classes for clearer states */
    .badge.good { background: rgba(120,224,143,0.06); color: inherit; }
    .badge.degraded { background: linear-gradient(90deg,var(--warn),#ffd39a40); color: #021219; }
    .badge.critical { background: linear-gradient(90deg,var(--danger),#ff9e9e); color: #021219; font-weight:700; }
  </style>
</head>
<body>
  <!-- Shared site header -->
  <header class="site-header">
    <div class="header-inner" role="banner" aria-label="Obsidian Bastion header">
      <div class="header-left">
        <div class="site-emblem" aria-hidden="true" title="Obsidian Bastion emblem">
          <img src="https://obviouslymelissa-hub.github.io/obsidianbastion/images/StrOpBoard.png" alt="Strategic Operations Board">
        </div>
        <div class="header-text" aria-label="Site title">
          <h1>Obsidian Bastion</h1>
          <h2>Network Health</h2>
        </div>
      </div>
      <div class="header-right">
        <a href="https://obviouslymelissa-hub.github.io/obsidianbastion/onboardcomputer.html" class="return-command-hub" aria-label="Return to Onboard Computer">← Return</a>
      </div>
    </div>
  </header>

  <div class="page-content">
    <div class="page-header">
      <div class="title">
        <h1>System Health Dashboard</h1>
        <div class="muted">Network & Server Observability Dashboard</div>
      </div>

      <div class="controls">
        <div class="seg" role="tablist" aria-label="Time range">
          <button data-range="1h" class="active" role="tab" aria-selected="true">1h</button>
          <button data-range="6h" role="tab" aria-selected="false">6h</button>
          <button data-range="24h" role="tab" aria-selected="false">24h</button>
        </div>

        <button id="exportCsv" class="primary" title="Export visible data as CSV">Export CSV</button>
      </div>
    </div>

  <div class="layout">
    <div class="left">
      <div class="card summary" aria-labelledby="overviewHeading">
        <h2 id="overviewHeading" style="margin:0 0 10px 0;font-size:14px">Overview</h2>

        <div class="stat" title="Current CPU utilization">
          <div>
            <div class="label">CPU Utilization</div>
            <div class="small">avg across hosts</div>
          </div>
          <div class="value" id="cpuNow">—%</div>
        </div>

        <div class="stat" title="I/O wait / throughput">
          <div>
            <div class="label">IO Wait</div>
            <div class="small">avg</div>
          </div>
          <div class="value" id="ioNow">— ms</div>
        </div>

        <div class="stat" title="Network latency / errors">
          <div>
            <div class="label">Network Latency</div>
            <div class="small">p50 / packet loss</div>
          </div>
          <div class="value" id="netNow">— ms</div>
        </div>


      </div>

      <div class="card" aria-labelledby="incTitle">
        <h3 id="incTitle" style="margin:0 0 8px 0;font-size:13px">Incident Log</h3>

        <div id="incidentLog" class="incident-log" aria-live="polite">
          <!-- incidents will be injected here -->
        </div>

        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="addSample" title="Add a sample incident">Add sample incident</button>
          <button id="clearResolved" title="Remove resolved incidents">Clear resolved</button>
        </div>

        <p class="small" style="margin-top:8px"><a href="https://obviouslymelissa-hub.github.io/obsidianbastion/onboardcomputer.html" style="color:var(--accent)">← Return to Onboard Computer</a></p>
      </div>
    </div>

    <main class="main">
      <div class="card toolbar" style="display: flex; justify-content: space-between; align-items: center;">
        <div class="badge good" id="healthBadge" style="margin-right: auto;">Health: Good</div>
        <div class="small" style="margin: 0 auto;" id="lastUpdated">last updated: —</div>
        <div style="display: flex; gap: 8px;">
          <button id="zoomOut">Zoom out</button>
          <button id="zoomIn">Zoom in</button>
        </div>
      </div>

      <div class="card chart-wrap" aria-live="polite">
        <canvas id="mainChart" height="220"></canvas>
      </div>

      <div class="card chart-wrap" style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:240px">
          <h4 style="margin:0 0 8px 0;font-size:13px">Service Contention</h4>
          <canvas id="contentionChart" height="140"></canvas>
        </div>
        <div style="flex:1;min-width:240px">
          <h4 style="margin:0 0 8px 0;font-size:13px">Packet Loss (last 1h)</h4>
          <canvas id="packetChart" height="140"></canvas>
        </div>
      </div>


    </main>
  </div>

  <script>
    /**************************************************************
     * System Health — interactive demo (trimmed)
     * - Chart.js v4
     * - Runs in simulated mode by default
     * - Includes a lightweight incident log UI (Runbook button removed)
     **************************************************************/

    // state
    const msInterval = 2000; // update interval for simulated mode
    let timer = null;

    // in-memory timeseries for the "visible window"
    let WINDOW_SIZE = 60; // number of points shown (approx)

    const series = {
      cpu: [],
      io: [],
      net: [],
      packetLoss: [],
      contention: []
    };

    // Simple incident model (in-memory)
    const incidents = [
      {
        id: generateId(),
        time: Date.now() - 1000 * 60 * 45,
        title: "DB queue backlog spike",
        severity: "high",
        status: "investigating",
        owner: "oncall-db",
        desc: "Increased IO latency on DB nodes causing request queuing. Initial mitigation: throttled batch jobs."
      },
      {
        id: generateId(),
        time: Date.now() - 1000 * 60 * 120,
        title: "Packet loss on northbound link",
        severity: "critical",
        status: "mitigated",
        owner: "network-team",
        desc: "Intermittent packet drops detected between datacenter A and B. Traffic rerouted to secondary path."
      }
    ];

    // helpers
    function generateId(){ return 'inc_' + Math.random().toString(36).slice(2,9); }
    function pushPoint(arr, point){
      arr.push(point);
      if (arr.length > WINDOW_SIZE) arr.shift();
    }

    function formatTimeISO(ts){
      const d = new Date(ts);
      return d.toLocaleString();
    }

    // Generate a single simulated datapoint (replace with real telemetry ingestion)
    function generateSimulatedPoint(baseTimestamp){
      const t = baseTimestamp;
      const cpu = Math.max(0, Math.min(100, 30 + Math.sin(t/60000*2*Math.PI)*12 + (Math.random()*12 - 6)));
      const io = Math.max(0, Math.min(500, 120 + Math.sin(t/30000*2*Math.PI)*40 + (Math.random()*60 - 30)));
      const net = Math.max(0, Math.min(200, 30 + Math.abs(Math.sin(t/20000))*40 + (Math.random()*30)));
      const packetLoss = Math.max(0, Math.min(10, Math.random()*2 + (cpu>85?Math.random()*6:0)));
      const contention = Math.max(0, Math.min(100, cpu * (io/400) * 1.2));

      return { t, cpu: +cpu.toFixed(1), io: +io.toFixed(1), net: +net.toFixed(1), packetLoss:+packetLoss.toFixed(2), contention:+contention.toFixed(1) };
    }

    // initialize arrays with a short history
    (function seed(){
      const start = Date.now() - WINDOW_SIZE*msInterval;
      for(let i=0;i<WINDOW_SIZE;i++){
        const p = generateSimulatedPoint(start + i*msInterval);
        pushPoint(series.cpu, {x:p.t, y:p.cpu});
        pushPoint(series.io, {x:p.t, y:p.io});
        pushPoint(series.net, {x:p.t, y:p.net});
        pushPoint(series.packetLoss, {x:p.t, y:p.packetLoss});
        pushPoint(series.contention, {x:p.t, y:p.contention});
      }
    })();

    // create charts
    const mainCtx = document.getElementById('mainChart').getContext('2d');
    const mainChart = new Chart(mainCtx, {
      type:'line',
      data:{
        datasets:[
          {label:'CPU %', data: series.cpu, borderColor:'#66a0ff', backgroundColor: 'rgba(102,160,255,0.06)', yAxisID:'y1', tension:0.3, fill:true},
          {label:'IO ms', data: series.io, borderColor:'#78e08f', backgroundColor: 'rgba(120,224,143,0.04)', yAxisID:'y2', tension:0.3},
          {label:'Net ms', data: series.net, borderColor:'#ffb86b', backgroundColor:'rgba(255,184,107,0.02)', yAxisID:'y2', tension:0.3}
        ]
      },
      options:{
        animation:false,
        maintainAspectRatio:false,
        scales:{
          x:{ 
            type:'linear', 
            ticks:{
              color:'#9fd6e0',
              callback: function(value) {
                const d = new Date(value);
                return d.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
              }
            }
          },
          y1:{ type:'linear', position:'left', min:0, max:100, ticks:{color:'#9fd6e0', callback: v => v+'%'}, title:{display:true,text:'CPU %', color:'#9fd6e0'} },
          y2:{ type:'linear', position:'right', min:0, ticks:{color:'#9fd6e0'}, title:{display:true,text:'ms', color:'#9fd6e0'}, grid:{drawOnChartArea:false} }
        },
        plugins:{
          legend:{labels:{color:'#d7eef0'}},
          tooltip:{
            callbacks:{
              title: function(context) {
                const d = new Date(context[0].parsed.x);
                return d.toLocaleString('en-US', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
              }
            }
          }
        }
      }
    });

    const contentionCtx = document.getElementById('contentionChart').getContext('2d');
    const contentionChart = new Chart(contentionCtx, {
      type:'bar',
      data:{
        labels: series.contention.map(d=>d.x),
        datasets:[
          {
            label:'Contention Score',
            data: series.contention,
            backgroundColor:'rgba(255,150,80,0.18)',
            borderColor:'rgba(255,150,80,0.8)',
            borderWidth:1
          }
        ]
      },
      options:{animation:false, parsing:false, scales:{x:{type:'linear', ticks:{display:false}}, y:{beginAtZero:true, max:100}}, plugins:{legend:{display:false}}}
    });

    const packetCtx = document.getElementById('packetChart').getContext('2d');
    const packetChart = new Chart(packetCtx, {
      type:'line',
      data:{datasets:[{label:'Packet Loss %', data: series.packetLoss, borderColor:'#ff7b7b', tension:0.2, pointRadius:2}]},
      options:{animation:false, parsing:false, scales:{x:{type:'linear', ticks:{display:false}}, y:{beginAtZero:true, max:15}}, plugins:{legend:{display:false}}}
    });

    // UI elements
    const cpuNowEl = document.getElementById('cpuNow');
    const ioNowEl = document.getElementById('ioNow');
    const netNowEl = document.getElementById('netNow');
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const healthBadge = document.getElementById('healthBadge');
    const incidentLogEl = document.getElementById('incidentLog');

    function updateSummary(){
      const lastCpu = series.cpu[series.cpu.length-1];
      const lastIo  = series.io[series.io.length-1];
      const lastNet = series.net[series.net.length-1];
      if (lastCpu) cpuNowEl.textContent = `${lastCpu.y}%`;
      if (lastIo)  ioNowEl.textContent = `${lastIo.y} ms`;
      if (lastNet) netNowEl.textContent = `${lastNet.y} ms`;

      const recentLoss = series.packetLoss.length ? series.packetLoss[series.packetLoss.length-1].y : 0;

      // thresholds:
      // - critical if packet loss > 5% or CPU > 95%
      // - degraded if packet loss > 3% or CPU > 90%
      if (recentLoss > 5 || (lastCpu && lastCpu.y > 95)) {
        healthBadge.textContent = 'Health: Critical';
        healthBadge.classList.remove('good','degraded');
        healthBadge.classList.add('critical');
      } else if (recentLoss > 3 || (lastCpu && lastCpu.y > 90)) {
        healthBadge.textContent = 'Health: Degraded';
        healthBadge.classList.remove('good','critical');
        healthBadge.classList.add('degraded');
      } else {
        healthBadge.textContent = 'Health: Good';
        healthBadge.classList.remove('degraded','critical');
        healthBadge.classList.add('good');
      }

      lastUpdatedEl.textContent = 'last updated: ' + formatTimeISO(Date.now());
    }

    // push a new datapoint into all series and update charts
    function ingestPoint(point){
      pushPoint(series.cpu, {x:point.t, y:point.cpu});
      pushPoint(series.io,  {x:point.t, y:point.io});
      pushPoint(series.net, {x:point.t, y:point.net});
      pushPoint(series.packetLoss, {x:point.t, y:point.packetLoss});
      pushPoint(series.contention, {x:point.t, y:point.contention});

      // update Chart.js datasets directly
      mainChart.data.datasets[0].data = series.cpu;
      mainChart.data.datasets[1].data = series.io;
      mainChart.data.datasets[2].data = series.net;
      mainChart.update('none');

      contentionChart.data.labels = series.contention.map(d=>d.x);
      contentionChart.data.datasets[0].data = series.contention;
      contentionChart.update('none');

      packetChart.data.datasets[0].data = series.packetLoss;
      packetChart.update('none');

      updateSummary();
    }

    // render incident log
    function renderIncidents(){
      incidentLogEl.innerHTML = '';
      if (incidents.length === 0){
        const p = document.createElement('div');
        p.className = 'small-muted';
        p.textContent = 'No incidents recorded.';
        incidentLogEl.appendChild(p);
        return;
      }

      // show newest first
      const sorted = incidents.slice().sort((a,b)=>b.time - a.time);
      sorted.forEach(inc => {
        const wrapper = document.createElement('div');
        wrapper.className = 'incident';
        if (inc.status === 'resolved') wrapper.classList.add('resolved');

        // Meta row at top: timestamp (left) and owner (right)
        const meta = document.createElement('div');
        meta.className = 'meta';
        const time = document.createElement('span');
        time.className = 'time';
        time.textContent = formatTimeISO(inc.time);
        meta.appendChild(time);
        const owner = document.createElement('div');
        owner.className = 'owner';
        owner.textContent = `Owner: ${inc.owner}`;
        meta.appendChild(owner);

        const main = document.createElement('div');
        main.className = 'main';
        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = inc.title + (inc.status === 'resolved' ? ' — Resolved' : '');
        main.appendChild(title);

        const desc = document.createElement('div');
        desc.className = 'desc';
        desc.textContent = inc.desc;
        main.appendChild(desc);

        // severity pill and status row
        const pill = document.createElement('span');
        pill.className = 'pill';
        if (inc.severity === 'critical') pill.classList.add('sev-critical');
        else if (inc.severity === 'high') pill.classList.add('sev-high');
        else pill.classList.add('sev-ok');
        pill.textContent = inc.severity.toUpperCase();

        const metaRow = document.createElement('div');
        metaRow.style.display = 'flex';
        metaRow.style.justifyContent = 'space-between';
        metaRow.style.alignItems = 'center';

        const leftGroup = document.createElement('div');
        leftGroup.appendChild(pill);
        const status = document.createElement('span');
        status.className = 'small-muted';
        status.style.marginLeft = '8px';
        status.textContent = `Status: ${inc.status}`;
        leftGroup.appendChild(status);

        metaRow.appendChild(leftGroup);

        const actions = document.createElement('div');
        actions.className = 'actions';
        // resolve / reopen
        const ackBtn = document.createElement('button');
        ackBtn.textContent = inc.status === 'resolved' ? 'Reopen' : 'Resolve';
        ackBtn.addEventListener('click', ()=>{
          toggleResolve(inc.id);
        });
        actions.appendChild(ackBtn);

        main.appendChild(metaRow);
        main.appendChild(actions);

        wrapper.appendChild(meta);   // top row with time + owner
        wrapper.appendChild(main);
        incidentLogEl.appendChild(wrapper);
      });
    }

    function toggleResolve(id){
      const idx = incidents.findIndex(i=>i.id===id);
      if (idx === -1) return;
      incidents[idx].status = incidents[idx].status === 'resolved' ? 'investigating' : 'resolved';
      renderIncidents();
    }

    // Add a simulated incident (for demo)
    function addSampleIncident(){
      const now = Date.now();
      const candidate = {
        id: generateId(),
        time: now,
        title: "Service latency spike",
        severity: Math.random() > 0.6 ? 'high' : 'critical',
        status: "investigating",
        owner: Math.random() > 0.5 ? 'oncall-app' : 'network-team',
        desc: "Observed elevated p99 latency for API requests. Investigating upstream dependencies and network paths."
      };
      incidents.push(candidate);
      renderIncidents();
    }

    // remove resolved incidents
    function clearResolved(){
      for (let i = incidents.length - 1; i >= 0; i--){
        if (incidents[i].status === 'resolved') incidents.splice(i,1);
      }
      renderIncidents();
    }

    // Simulated run loop
    function startSimulated(){
      if (timer) clearInterval(timer);
      timer = setInterval(()=> {
        const p = generateSimulatedPoint(Date.now());
        ingestPoint(p);
      }, msInterval);
    }

    function stopSimulated(){
      if (timer) { clearInterval(timer); timer = null; }
    }

    // Export CSV of visible window (this button is functional)
    document.getElementById('exportCsv').addEventListener('click', ()=>{
      const rows = [['timestamp_iso', 'epoch_ms', 'cpu_pct', 'io_ms', 'net_ms', 'packet_loss_pct', 'contention']];
      for (let i=0;i<series.cpu.length;i++){
        const t = series.cpu[i].x;
        const cpu = series.cpu[i].y;
        const io = series.io[i]?.y ?? '';
        const net = series.net[i]?.y ?? '';
        const pl = series.packetLoss[i]?.y ?? '';
        const cont = series.contention[i]?.y ?? '';
        rows.push([new Date(t).toISOString(), t, cpu, io, net, pl, cont]);
      }
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `system-health-${new Date().toISOString()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // time range buttons (they only change window size for this demo)
    document.querySelectorAll('.seg button').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        document.querySelectorAll('.seg button').forEach(b=>{
          b.classList.remove('active');
          b.setAttribute('aria-selected', 'false');
        });
        e.currentTarget.classList.add('active');
        e.currentTarget.setAttribute('aria-selected', 'true');
        document.querySelectorAll('.seg button').forEach(b=>b.classList.remove('active'));
        e.currentTarget.classList.add('active');
        const range = e.currentTarget.dataset.range;
        if (range==='1h'){ setWindowSize(60); }
        if (range==='6h'){ setWindowSize(180); }
        if (range==='24h'){ setWindowSize(720); }
      });
    });

    function setWindowSize(n){
      WINDOW_SIZE = n;
      while(series.cpu.length > n) series.cpu.shift();
      while(series.io.length > n) series.io.shift();
      while(series.net.length > n) series.net.shift();
      while(series.packetLoss.length > n) series.packetLoss.shift();
      while(series.contention.length > n) series.contention.shift();

      const needed = n - series.cpu.length;
      if (needed > 0){
        const start = Date.now() - (n*msInterval);
        for(let i=0;i<needed;i++){
          const p = generateSimulatedPoint(start + i*msInterval);
          pushPoint(series.cpu, {x:p.t, y:p.cpu});
          pushPoint(series.io,  {x:p.t, y:p.io});
          pushPoint(series.net, {x:p.t, y:p.net});
          pushPoint(series.packetLoss, {x:p.t, y:p.packetLoss});
          pushPoint(series.contention, {x:p.t, y:p.contention});
        }
      }

      mainChart.data.datasets[0].data = series.cpu;
      mainChart.data.datasets[1].data = series.io;
      mainChart.data.datasets[2].data = series.net;
      mainChart.update();

      contentionChart.update(); packetChart.update();
    }

    // Zoom buttons: simple approach — change Y scaling for CPU
    document.getElementById('zoomIn').addEventListener('click', ()=>{
      const y1 = mainChart.options.scales.y1;
      if (y1.max > 40) y1.max = Math.max(40, y1.max - 10);
      mainChart.update();
    });
    document.getElementById('zoomOut').addEventListener('click', ()=>{
      const y1 = mainChart.options.scales.y1;
      y1.max = Math.min(200, (y1.max || 100) + 20);
      mainChart.update();
    });

    // incident controls
    document.getElementById('addSample').addEventListener('click', addSampleIncident);
    document.getElementById('clearResolved').addEventListener('click', clearResolved);

    // initial render/start
    renderIncidents();
    startSimulated();
    updateSummary();

    // expose ingestion helper for integrations
    window.SystemHealth = {
      ingestPoint,
      addIncident: function(obj){
        // expected fields: {time, title, severity, owner, desc}
        const inc = Object.assign({ id: generateId(), status: 'investigating', time: Date.now() }, obj);
        incidents.push(inc);
        renderIncidents();
      },
      listIncidents: () => incidents.slice()
    };
  </script>

  <footer style="text-align:center;color:var(--muted);padding:24px 0 40px;border-top:1px solid rgba(255,255,255,0.03);margin-top:18px;font-style:italic;">
    <div style="margin-bottom:12px">
      <a href="https://obviouslymelissa-hub.github.io/obsidianbastion/index.html" style="color:var(--accent);text-decoration:none;font-weight:600">Vessel Profile</a>
    </div>
    &copy; 2026 - Turning Imagination Into Galactic Frontiers.
  </footer>
  </div>
</body>
</html>
