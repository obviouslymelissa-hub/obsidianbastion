<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Power Management</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <link rel="stylesheet" href="app.css">
  <style>
    :root{
      --bg-dark: #0f1318;
      --bg-panel: #151821;
      --accent: #4fd1c5;
      --accent-2: #7ef0df;
      --text-main: #e6eef2;
      --text-muted: #9fb2bf;
      --border: #22272f;
      --bg: #0b0f14;
      --panel: #0f1720;
      --muted: #93a3b9;
      --danger: #ff6b6b;
      --glass: rgba(255,255,255,0.03);
      --radius: 10px;
    }

    html,body{height:100%; margin:0; font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;}
    body{ color:var(--text-main); padding:0; box-sizing:border-box; background: var(--bg-dark); }

    .page-content { padding: 24px; }

    /* Site header styles */
    .site-header {
      background:
        radial-gradient(600px 120px at 10% 30%, rgba(127,240,223,0.06), transparent 8%),
        radial-gradient(500px 100px at 90% 60%, rgba(79,209,197,0.04), transparent 6%),
        linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      border-bottom: 2px solid rgba(79,209,197,0.12);
      padding: 12px 18px;
    }
    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 18px;
      justify-content: space-between;
      padding: 8px 6px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 14px;
      min-width: 0;
    }
    .site-emblem {
      width: 60px;
      height: 60px;
      flex: 0 0 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(127,240,223,0.06), rgba(79,209,197,0.02));
      border: 1px solid rgba(127,240,223,0.08);
      box-shadow: 0 6px 20px rgba(0,0,0,0.5), 0 0 30px rgba(79,209,197,0.02) inset;
    }
    .site-emblem img {
      width: 42px;
      height: 42px;
      display: block;
      object-fit: contain;
    }
    .header-text h1 {
      margin: 0;
      font-size: 1.3rem;
      color: var(--text-main);
      letter-spacing: 1.2px;
      font-weight: 800;
    }
    .header-text h2 {
      margin: 4px 0 0 0;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.6px;
    }
    .return-command-hub {
      background: var(--accent);
      color: var(--bg-panel);
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 700;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .return-command-hub:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }

    .page-header{ display:flex; flex-direction:column; gap:12px; margin-bottom:18px; }
    .top-row{ display:flex; align-items:center; gap:16px; }
    .brand { display:flex; align-items:center; gap:10px; }
    .title-wrap{ display:flex; flex-direction:column; gap:2px; }
    h1{font-size:20px; margin:0;}
    p.subtitle{margin:0; color:var(--muted); font-size:13px;}

    main{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:18px;
      align-items:start;
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: var(--radius);
      padding:14px;
      border: 1px solid rgba(255,255,255,0.03);
      box-shadow: 0 8px 30px rgba(2,6,23,0.6);
      overflow: hidden;
    }

    /* Layout */
    .left{ grid-column: span 8; display:flex; flex-direction:column; gap:18px; }
    .right{ grid-column: span 4; display:flex; flex-direction:column; gap:12px; }

    /* RIGHT: improved grid inside panel */
    .right .energy-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: center;
    }
    .energy-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border-radius: 8px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.03);
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
      justify-content:center;
    }

    .battery-svg { width:100%; height:140px; display:block; }
    .battery-wrap { display:flex; flex-direction:column; gap:6px; align-items:center; width:100%; }

    .battery-overlay {
      position: relative;
      width:100%;
      max-width:180px;
      margin:0 auto;
    }
    .battery-overlay .battery-fill {
      transition: width 600ms ease;
      height:44px;
      border-radius:4px;
    }
    .battery-percent {
      margin-top:6px;
      font-weight:800;
      font-size:18px;
      color:var(--accent-2);
    }

    .fuel-chart-wrap { display:flex; gap:10px; width:100%; align-items:center; margin-top:0; }
    .fuel-chart-area { flex:1; display:flex; justify-content:center; align-items:center; position:relative; }
    .fuel-chart-area .chart-wrap { height:120px; width:120px; position:relative; }
    .fuel-center {
      position:absolute; left:0; top:0; right:0; bottom:0;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none; font-weight:800; color:var(--accent-2); font-size:20px;
    }
    .fuel-info { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; }
    .fuel-info .label { color:var(--muted); font-size:12px; font-weight:600; }
    .fuel-info .percent { font-size:22px; font-weight:800; color:var(--accent-2); }

    .controls{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .controls .group { display:flex; gap:8px; flex-wrap:wrap; width:100%; }
    .btn{ background:transparent; border:1px solid rgba(255,255,255,0.06); padding:8px 10px; color:var(--text-muted); border-radius:8px; cursor:pointer; font-size:13px; }
    .btn.primary{ background:var(--accent); color:var(--bg-panel); border:none; box-shadow:0 6px 20px rgba(0,0,0,0.35); font-weight:700; }
    .btn.primary:hover{ transform: translateY(-2px); box-shadow:0 10px 30px rgba(0,0,0,0.45); }
    .btn.danger{ border-color: rgba(255,107,107,0.18); color:var(--danger); box-shadow:0 8px 18px rgba(255,107,107,0.04); }

    .logs { max-height:200px; overflow:auto; padding:8px; background: rgba(0,0,0,0.06); border-radius:8px; border:1px solid rgba(255,255,255,0.02); font-family: monospace; font-size:12px; color:#dbeef3; }

    /* Status row for horizontal alignment */
    .status-row {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      justify-content: space-around;
    }
    .stat {
      flex: 1;
      text-align: center;
    }
    .stat h3 {
      margin: 0 0 6px 0;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
    }
    .stat p {
      margin: 0;
      font-size: 18px;
      font-weight: 800;
      color: var(--accent-2);
    }

    @media (max-width:900px){
      main{ grid-template-columns: repeat(6, 1fr); }
      .left{ grid-column: span 6; }
      .right{ grid-column: span 6; }
      .chart-wrap.large{ height:220px; }
      .right .energy-grid { grid-template-columns: 1fr; }
    }

  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-inner" role="banner" aria-label="Obsidian Bastion header">
      <div class="header-left">
        <div class="site-emblem" aria-hidden="true" title="Obsidian Bastion emblem">
          <img src="https://obviouslymelissa-hub.github.io/obsidianbastion/images/StrOpBoard.png" alt="Strategic Operations Board" style="height:42px;">
        </div>
        <div class="header-text" aria-label="Site title">
          <h1>Obsidian Bastion</h1>
          <h2>Power Management</h2>
        </div>
      </div>
      <div class="header-right">
        <a href="https://obviouslymelissa-hub.github.io/obsidianbastion/onboardcomputer.html" class="return-command-hub" aria-label="Return to Onboard Computer">← Return</a>
      </div>
    </div>
  </header>

  <div class="page-content">
    <div class="page-header">
      <div class="top-row">
        <div class="brand">
          <div class="title-wrap">
            <h1>Power Management Console</h1>
            <p class="subtitle">Ship power, fuel and reactor telemetry</p>
          </div>
        </div>
      </div>
    </div>

    <main>
      <!-- LEFT: Overall power + Reactor -->
      <section class="panel left">
        <div>
          <h3 style="margin:0 0 8px 0; color:var(--muted); font-size:13px">Overall Power (kW)</h3>
          <div class="chart-wrap large" style="height:360px;">
            <canvas id="powerChart"></canvas>
          </div>

          <div class="status-row">
            <div class="stat">
              <h3>Overall Power</h3>
              <p id="overallPowerValue">-- kW</p>
            </div>

            <div class="stat">
              <h3>Grid Load</h3>
              <p id="loadValue">-- kW</p>
            </div>

            <div class="stat">
              <h3>Reactor Temp</h3>
              <p id="tempValue">-- °F</p>
            </div>
          </div>
        </div>

        <div style="margin-top:18px;">
          <h3 style="margin:0 0 8px 0; color:var(--muted); font-size:13px">Reactor Output (kW)</h3>
          <div class="chart-wrap small-chart" style="height:90px;">
            <canvas id="reactorChart"></canvas>
          </div>
        </div>
      </section>

      <!-- RIGHT: Battery, Fuel (doughnut), Controls, Logs -->
      <aside class="panel right">
        <div class="energy-grid">
          <!-- Battery card -->
          <div class="energy-card battery-wrap" aria-label="Battery status">
            <h3 style="margin:0; color:var(--muted); font-size:13px; width:100%; text-align:left;">Battery</h3>
            <div class="battery-overlay" aria-hidden="false">
              <!-- simplified battery visuals: background + fill -->
              <div style="height:48px; background:rgba(255,255,255,0.03); border-radius:6px; border:1px solid rgba(255,255,255,0.04); overflow:hidden; position:relative;">
                <div id="batteryFillBg" style="position:absolute; left:0; top:0; bottom:0; right:0; background:transparent;"></div>
                <div id="batteryFillSimple" class="battery-fill" style="position:absolute; left:0; top:0; bottom:0; width:0; background:linear-gradient(90deg,#ffda6b,#ffb84d);"></div>
              </div>
            </div>
            <div class="battery-percent" id="batteryValue">--%</div>

            <!-- Charge button placed inside battery card -->
            <div style="margin-top:6px; width:100%; display:flex; justify-content:center;">
              <button id="chargeBtn" class="btn">Charge Battery</button>
            </div>

            <div style="font-size:12px;color:var(--muted); text-align:center; max-width:220px;">Stored energy from the battery bank. Automatically charges when reactor has surplus power.</div>
          </div>

          <!-- Fuel card -->
          <div class="energy-card" aria-label="Fuel storage">
            <h3 style="margin:0; color:var(--muted); font-size:13px; width:100%; text-align:left;">Fuel Storage</h3>
            <div class="fuel-chart-area" style="width:100%; justify-content:center;">
              <div class="chart-wrap" style="height:120px; width:120px; margin:0;">
                <canvas id="fuelChart"></canvas>
                <div class="fuel-center" id="fuelCenter">--%</div>
              </div>
            </div>

            <!-- Add fuel button placed inside fuel card -->
            <div style="margin-top:6px; width:100%; display:flex; justify-content:center;">
              <button id="addFuelBtn" class="btn">Add Fuel</button>
            </div>
          </div>
        </div>

        <div style="margin-top:6px;">
          <h3 style="color:var(--muted); font-size:13px; margin:0 0 8px 0;">Controls</h3>
          <div class="controls">
            <div class="group" style="flex-direction:column; gap:12px;">
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button id="boostBtn" class="btn">Activate Boosters</button>
                <button id="drainBtn" class="btn">Increase Thrust</button>
              </div>
              <button id="shutdownBtn" class="btn danger" style="width:100%; font-size:15px; padding:12px 10px;">Shutdown System</button>
            </div>
          </div>
        </div>

        <div style="margin-top:8px;">
          <h3 style="margin:0 0 8px 0; color:var(--muted); font-size:13px">Logs</h3>
          <div id="logs" class="logs" aria-live="polite"></div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // ---------------------------
    // State
    // ---------------------------
    const POINTS = 60;

    let batteryLevel = 78; // %
    let fuelPercent = 62; // %
    let gridLoad = 420; // kW
    let reactorOutput = 480; // kW
    let reactorTempF = 860; // F

    // shutdownPhase: 'none' (normal), 'ramping' (gradual shutdown), 'off' (fully off)
    let shutdownPhase = 'none';

    const MAX_BATTERY_KW = 300; // battery contribution when at 100%

    // histories
    function makeHistory(len, start) {
      const arr = [];
      let v = start;
      for (let i=0;i<len;i++){
        v = v + (Math.random()*2 -1)*1.5;
        arr.push(Math.max(0, Math.round(v*100)/100));
      }
      return arr;
    }
    const overallHistory = makeHistory(POINTS, reactorOutput + (batteryLevel/100)*MAX_BATTERY_KW);
    const reactorHistory = makeHistory(POINTS, reactorOutput);

    // ---------------------------
    // Logging (limit length)
    // ---------------------------
    const logsEl = document.getElementById('logs');
    const LOG_LIMIT = 100; // keep logs short

    function addLog(msg){
      const ts = new Date().toLocaleTimeString();
      const line = document.createElement('div');
      line.textContent = `[${ts}] ${msg}`;
      logsEl.prepend(line);
      while (logsEl.children.length > LOG_LIMIT) logsEl.removeChild(logsEl.lastChild);
    }

    // ---------------------------
    // Chart plugin (optimal zone highlight)
    // ---------------------------
    const optimalZonePlugin = {
      id: 'optimalZone',
      beforeDatasetsDraw(chart, args, options) {
        if (!options || !options.range) return;
        const ctx = chart.ctx;
        const {left, right} = chart.chartArea;
        const yScale = chart.scales.y;
        if (!yScale) return;
        const [minVal, maxVal] = options.range;
        const yTop = yScale.getPixelForValue(maxVal);
        const yBottom = yScale.getPixelForValue(minVal);
        ctx.save();
        ctx.fillStyle = options.color || 'rgba(45,212,191,0.06)';
        ctx.fillRect(left, yTop, right - left, yBottom - yTop);
        if (options.borderColor) {
          ctx.strokeStyle = options.borderColor;
          ctx.lineWidth = options.borderWidth || 1;
          ctx.strokeRect(left + 0.5, yTop + 0.5, right - left - 1, yBottom - yTop - 1);
        }
        ctx.restore();
      }
    };
    Chart.register(optimalZonePlugin);

    // ---------------------------
    // Common options & labels
    // ---------------------------
    const commonOptions = {
      animation: { duration: 240, easing: 'linear' },
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { top: 6, bottom: 6, left: 6, right: 6 } },
      scales: { x: { display: false } },
      plugins: { legend: { display:false }, tooltip: { enabled: true, mode: 'index', intersect: false } }
    };
    function makeLabels(n){ const labels=[]; for(let i=n-1;i>=0;i--) labels.push((i*-1)+'s'); return labels; }
    const labels = makeLabels(POINTS);
    const eventEmpty = Array(POINTS).fill(null);

    // ---------------------------
    // Charts
    // ---------------------------
    const ctxPower = document.getElementById('powerChart').getContext('2d');
    const POWER_OPTIMAL_KW = [600, 900];
    const powerChart = new Chart(ctxPower, {
      type: 'line',
      data: {
        labels,
        datasets:[
          { label:'Overall Power (kW)', data: overallHistory, borderColor:'rgba(45,212,191,0.95)', backgroundColor:'rgba(45,212,191,0.06)', tension:0.18, pointRadius:0, fill:true },
          { label:'Event', data:eventEmpty.slice(), borderColor:'rgba(255,223,63,0.95)', backgroundColor:'rgba(255,223,63,0.06)', tension:0.18, pointRadius:0, borderWidth:3, order:2 }
        ]
      },
      options: Object.assign({}, commonOptions, {
        scales:{ y:{ beginAtZero:true, ticks:{ color:'#bcd6dd' } } },
        plugins: Object.assign({}, commonOptions.plugins, { optimalZone:{ range: POWER_OPTIMAL_KW, color:'rgba(45,212,191,0.06)', borderColor:'rgba(45,212,191,0.12)', borderWidth:1 } })
      })
    });

    const ctxReact = document.getElementById('reactorChart').getContext('2d');
    const REACTOR_OPT = [420,540];
    const reactorChart = new Chart(ctxReact, {
      type:'line',
      data:{ labels, datasets:[
        { label:'Reactor Output (kW)', data: reactorHistory, borderColor:'rgba(96,165,250,0.9)', backgroundColor:'rgba(96,165,250,0.06)', tension:0.18, pointRadius:0, fill:true },
        { label:'Event', data:eventEmpty.slice(), borderColor:'rgba(255,223,63,0.95)', backgroundColor:'rgba(255,223,63,0.06)', tension:0.22, pointRadius:0, borderWidth:3, order:2 }
      ]},
      options: Object.assign({}, commonOptions, {
        scales:{ y:{ beginAtZero:true, ticks:{ color:'#bcd6dd' } } },
        plugins: Object.assign({}, commonOptions.plugins, { optimalZone:{ range: REACTOR_OPT, color:'rgba(96,165,250,0.06)', borderColor:'rgba(96,165,250,0.12)', borderWidth:1 } })
      })
    });

    const ctxFuel = document.getElementById('fuelChart').getContext('2d');
    const fuelChart = new Chart(ctxFuel, {
      type: 'doughnut',
      data: { labels: ['Fuel','Empty'], datasets:[{ data: [fuelPercent, 100-fuelPercent], backgroundColor:['rgba(255,193,7,0.95)','rgba(255,255,255,0.06)'], hoverOffset:4, borderWidth:0 }] },
      options: { cutout: '70%', responsive:true, maintainAspectRatio:false, plugins:{ tooltip:{ enabled:false }, legend:{ display:false } } }
    });

    // ---------------------------
    // DOM helpers
    // ---------------------------
    const batteryEl = document.getElementById('batteryValue');
    const fuelCenterEl = document.getElementById('fuelCenter');
    const loadEl = document.getElementById('loadValue');
    const tempEl = document.getElementById('tempValue');
    const overallPowerEl = document.getElementById('overallPowerValue');
    const batteryFillSimple = document.getElementById('batteryFillSimple');

    function nextValue(prev, target, stepFraction=0.12, jitter=1) {
      const diff = target - prev;
      return prev + diff*stepFraction + (Math.random()*2-1)*jitter*0.6;
    }
    function updateBatterySimple(pct) {
      const w = Math.max(0, Math.min(100, pct));
      batteryFillSimple.style.width = w + '%';
    }
    function calculateOverallPower() {
      // During shutdown, overall power should be 0
      if (shutdownPhase === 'ramping' || shutdownPhase === 'off') {
        return 0;
      }
      const batteryContribution = (batteryLevel/100) * MAX_BATTERY_KW;
      return Math.max(0, Math.round(reactorOutput + batteryContribution));
    }

    function updateReads(){
      batteryEl.textContent = Math.max(0, Math.min(100, batteryLevel)).toFixed(0) + '%';
      fuelCenterEl.textContent = Math.max(0, Math.min(100, fuelPercent)).toFixed(0) + '%';
      loadEl.textContent = Math.max(0, Math.min(99999, gridLoad)).toFixed(0) + ' kW';
      tempEl.textContent = reactorTempF.toFixed(0) + ' °F';
      overallPowerEl.textContent = Math.round(calculateOverallPower()) + ' kW';
      updateBatterySimple(batteryLevel);
    }

    // ---------------------------
    // Controls
    // ---------------------------
    const boostBtn = document.getElementById('boostBtn');
    const drainBtn = document.getElementById('drainBtn');
    const addFuelBtn = document.getElementById('addFuelBtn');
    const chargeBtn = document.getElementById('chargeBtn');
    const shutdownBtn = document.getElementById('shutdownBtn');

    let boostActive = false, drainActive = false;
    let boostEventRemaining = 0, drainEventRemaining = 0, fuelEventRemaining = 0;

    function injectImmediateOverlay(chart, datasetIndex, value) {
      const ds = chart.data.datasets[datasetIndex];
      if (!ds) return;
      ds.data[ds.data.length - 1] = value;
      chart.update('none');
    }

    function setBoost(active) {
      if (shutdownPhase !== 'none') { addLog('Cannot boost while shutdown; wait until restart.'); return; }
      boostActive = active;
      boostEventRemaining = active ? 6 : 0;
      boostBtn.classList.toggle('primary', active);
      boostBtn.textContent = active ? 'Deactivate Boosters' : 'Activate Boosters';
      if (active) {
        injectImmediateOverlay(reactorChart, 1, reactorOutput + 160);
        injectImmediateOverlay(powerChart, 1, calculateOverallPower() + 160);
      } else {
        injectImmediateOverlay(reactorChart, 1, null);
        injectImmediateOverlay(powerChart, 1, null);
      }
    }

    function setDrain(active) {
      if (shutdownPhase !== 'none') { addLog('Cannot increase thrust while shutdown; wait until restart.'); return; }
      drainActive = active;
      drainEventRemaining = active ? 8 : 0;
      drainBtn.classList.toggle('primary', active);
      drainBtn.textContent = active ? 'Stop Thrust Increase' : 'Increase Thrust';
      if (active) {
        injectImmediateOverlay(reactorChart, 1, reactorOutput + 260);
        injectImmediateOverlay(powerChart, 1, calculateOverallPower() + 260);
      } else {
        injectImmediateOverlay(reactorChart, 1, null);
        injectImmediateOverlay(powerChart, 1, null);
      }
    }

    boostBtn.addEventListener('click', () => setBoost(!boostActive));
    drainBtn.addEventListener('click', () => setDrain(!drainActive));

    addFuelBtn.onclick = () => {
      if (shutdownPhase !== 'none') { addLog('Cannot add fuel while shutdown.'); return; }
      const added = 10 + Math.round(Math.random()*8);
      fuelPercent = Math.min(100, fuelPercent + added);
      fuelChart.data.datasets[0].data[0] = fuelPercent;
      fuelChart.data.datasets[0].data[1] = 100-fuelPercent;
      fuelChart.update();
      addLog(`Fuel added: +${added}%.`);
      updateReads();
    };

    chargeBtn.onclick = () => {
      if (shutdownPhase !== 'none') { addLog('Cannot charge while shutdown.'); return; }
      const fuelNeeded = 8 + Math.round(Math.random()*6);
      if (fuelPercent < 2) { addLog('Charge attempt failed: insufficient fuel.'); return; }
      const actualFuelUsed = Math.min(fuelPercent, fuelNeeded);
      fuelPercent = Math.max(0, fuelPercent - actualFuelUsed);
      const gain = Math.round(actualFuelUsed * (0.6 + Math.random()*0.4));
      batteryLevel = Math.min(100, batteryLevel + gain);
      fuelChart.data.datasets[0].data[0] = fuelPercent;
      fuelChart.data.datasets[0].data[1] = 100 - fuelPercent;
      fuelChart.update();
      addLog(`Battery charged: +${gain}% (fuel used: ${actualFuelUsed}%).`);
      updateReads();
    };

    shutdownBtn.addEventListener('click', () => {
      // toggle shutdown Phase: if currently none -> start ramping; if off or ramping -> request restart (clear)
      if (shutdownPhase === 'none') {
        shutdownPhase = 'ramping';
        shutdownBtn.classList.add('primary');
        shutdownBtn.textContent = 'Restart System';
        // make sure events are stopped
        boostActive = drainActive = false;
        boostEventRemaining = drainEventRemaining = fuelEventRemaining = 0;
        boostBtn.classList.remove('primary'); boostBtn.textContent = 'Activate Boosters';
        drainBtn.classList.remove('primary'); drainBtn.textContent = 'Increase Thrust';
        addLog('SYSTEM SHUTDOWN INITIATED: ramping down reactor, grid and core temperature.');
        injectImmediateOverlay(reactorChart, 1, null);
        injectImmediateOverlay(powerChart, 1, null);
      } else {
        shutdownPhase = 'none';
        shutdownBtn.classList.remove('primary');
        shutdownBtn.textContent = 'Shutdown System';
        addLog('SYSTEM RESTART REQUESTED: resuming normal simulation.');
      }
    });

    // ---------------------------
    // Axis helpers
    // ---------------------------
    function setDynamicYAxis(chart, currentValue, lowerClamp=0, maxCap=Number.POSITIVE_INFINITY, fixedRange=null) {
      if (!chart.options.scales) chart.options.scales = {};
      if (!chart.options.scales.y) chart.options.scales.y = {};
      if (fixedRange && fixedRange > 0) {
        const half = fixedRange / 2;
        chart.options.scales.y.suggestedMin = Math.max(lowerClamp, currentValue - half);
        chart.options.scales.y.suggestedMax = Math.min(maxCap, currentValue + half);
      } else {
        const margin = Math.max(20, Math.abs(currentValue) * 0.45);
        chart.options.scales.y.suggestedMin = Math.max(lowerClamp, currentValue - margin);
        chart.options.scales.y.suggestedMax = Math.min(maxCap, currentValue + margin);
      }
    }

    // ---------------------------
    // Main loop (1s)
    // ---------------------------
    let tick = 0;
    setInterval(() => {
      tick++;

      if (shutdownPhase === 'ramping') {
        reactorOutput = Math.max(0, nextValue(reactorOutput, 0, 0.28, 2));
        gridLoad = Math.max(0, nextValue(gridLoad, 0, 0.28, 4));
        reactorTempF = Math.max(0, nextValue(reactorTempF, 0, 0.22, 6));

        if (reactorOutput < 0.5 && gridLoad < 0.5 && reactorTempF < 0.5) {
          reactorOutput = 0;
          gridLoad = 0;
          reactorTempF = 0;
          shutdownPhase = 'off';
          addLog('SYSTEM SHUTDOWN COMPLETE: reactor, grid and core temperature at 0 and held.');
        }

        batteryLevel = nextValue(batteryLevel, Math.max(2, batteryLevel - 0.05), 0.04, 0.2);
        fuelPercent = Math.max(0, fuelPercent - 0.001);

      } else if (shutdownPhase === 'off') {
        reactorOutput = 0;
        gridLoad = 0;
        reactorTempF = 0;
        batteryLevel = nextValue(batteryLevel, Math.max(2, batteryLevel - 0.05), 0.03, 0.2);
        fuelPercent = Math.max(0, fuelPercent - 0.001);

      } else {
        const surplus = reactorOutput - gridLoad;
        if (surplus >= 40 && !boostActive && !drainActive) {
          batteryLevel = Math.min(100, batteryLevel + (0.08 + Math.random()*0.06));
        } else if (surplus < -20 || drainActive) {
          batteryLevel = Math.max(0, batteryLevel - (0.12 + Math.random()*0.12));
        } else {
          batteryLevel = batteryLevel + (Math.random()*0.2 - 0.1);
          batteryLevel = Math.max(0, Math.min(100, batteryLevel));
        }

        let reactorTarget = gridLoad + (Math.random()*10 -5);
        if (boostActive) reactorTarget += 160;
        if (drainActive) reactorTarget += 260 * Math.random();
        reactorOutput = nextValue(reactorOutput, reactorTarget, 0.12, 3.2);

        let baseOptimalCenter = 878;
        let reactorTargetF = baseOptimalCenter + (reactorOutput - 480)*0.04 + (Math.random()*18 - 9);
        if (boostActive) reactorTargetF += 40 + Math.random()*40;
        if (drainActive) reactorTargetF += (Math.random()*80 - 20);

        if (Math.random() < 0.02) {
          const spike = (Math.random() > 0.5) ? 120 + Math.random()*80 : -(120 + Math.random()*80);
          reactorTargetF += spike;
          if (Math.abs(spike) >= 100) addLog(`Reactor ${spike>0?'spike':'dip'}: ${Math.round(spike)} °F.`);
        }

        reactorTempF = nextValue(reactorTempF, reactorTargetF, 0.12, 3.8);

        // fuel consumption
        fuelPercent -= (reactorOutput / 100000) + (Math.random()*0.02);
        if (fuelPercent < 6) { fuelPercent = 6 + Math.random()*2; addLog('Fuel low: emergency reserves in use.'); }

        if (Math.random() < 0.08) {
          const change = (Math.random()*200 - 100);
          gridLoad += change;
        }
        gridLoad = Math.max(0, Math.min(900, gridLoad + (Math.random()*6-3)));
      }

      // overlays for visuals (events suppressed during shutdown)
      let eventValPower = null, eventValReactor = null;
      if (shutdownPhase === 'none') {
        if ((boostEventRemaining > 0 || boostActive)) {
          eventValReactor = reactorOutput + 160;
          eventValPower = calculateOverallPower() + 160;
        } else if ((drainEventRemaining > 0 || drainActive)) {
          eventValReactor = reactorOutput + 260;
          eventValPower = calculateOverallPower() + 260;
        } else if (fuelEventRemaining > 0) {
          eventValPower = calculateOverallPower() + 20;
        }
      }

      powerChart.data.datasets[0].data.shift();
      powerChart.data.datasets[0].data.push(calculateOverallPower());
      powerChart.data.datasets[1].data.shift();
      powerChart.data.datasets[1].data.push(eventValPower);

      reactorChart.data.datasets[0].data.shift();
      reactorChart.data.datasets[0].data.push(Math.max(0, reactorOutput));
      reactorChart.data.datasets[1].data.shift();
      reactorChart.data.datasets[1].data.push(eventValReactor);

      fuelChart.data.datasets[0].data[0] = Math.max(0, Math.min(100, fuelPercent));
      fuelChart.data.datasets[0].data[1] = Math.max(0, 100 - fuelChart.data.datasets[0].data[0]);

      // decrement event timers
      if (boostEventRemaining > 0) boostEventRemaining--;
      if (drainEventRemaining > 0) drainEventRemaining--;
      if (fuelEventRemaining > 0) fuelEventRemaining--;

      // dynamic axes
      setDynamicYAxis(powerChart, calculateOverallPower(), 0, 3000, null);
      setDynamicYAxis(reactorChart, reactorOutput, 0, 2000, null);

      // update charts & UI
      powerChart.update();
      reactorChart.update();
      fuelChart.update();
      updateReads();
    }, 1000);

    // initialize UI
    updateReads();
    fuelChart.update();
    addLog('Power Management: initialized. Right-hand layout updated; buttons placed inside their energy cards.');

    // debug accessor
    window._pm = { state: () => ({batteryLevel,fuelPercent,gridLoad,reactorOutput,reactorTempF,shutdownPhase}) };
  </script>

  <footer style="text-align:center;color:var(--muted);padding:24px 0 40px;border-top:1px solid rgba(255,255,255,0.03);margin-top:18px;font-style:italic;">
    <div style="margin-bottom:12px">
      <a href="https://obviouslymelissa-hub.github.io/obsidianbastion/index.html" style="color:var(--accent);text-decoration:none;font-weight:600">Vessel Profile</a>
    </div>
    &copy; 2026 - Turning Imagination Into Galactic Frontiers.
  </footer>
</body>
</html>
